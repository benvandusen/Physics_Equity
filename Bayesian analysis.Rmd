# R code demonstrating a Bayesian analysis using R and Stan

# To run this file:

# Create a folder called 'Regression'
#   Currently, the code assumes this is in the C drive as C:\Bayes Course\Analyses\Regression\

# Inside the 'Regression' folder, create a subfolder called 'R'
#   Currently, the code assumes this is in the C drive as C:\Bayes Course\Analyses\Regression\R\
#   Store this file in the 'R' folder

# Inside the 'Regression' folder, create a subfolder called 'Data'
#   Currently, the code assumes this is in the C drive as C:\Bayes Course\Analyses\Regression\Data\
#   Store the 'Regression Example.dat' file in the 'Data' folder


# Remove objects from memory ---------------
```{r}
rm(list=ls())
```

# Define folders with locations ---------------
# Here is where you can change the location of the "main folder" 
```{r}
main.folder <- "~/Physics_Equity/"
R.folder <- paste0(main.folder, "R/")
data.folder <- paste0(main.folder, "Data/")
stan.folder <- paste0(main.folder, "stan/")
dir.create(stan.folder)
model.folder <- paste0(stan.folder, "Multiple Regression/")
dir.create(model.folder)
```

# Read in the Data ------------
```{r}
raw.data <- read.table(file=paste0(data.folder, "Regression Example.dat"), header=TRUE)
data.for.stan1 <- data.frame(raw.data)
data.for.stan2 <- data.frame(MIdata[[1]])
```


# Call the packages ------------
```{r}
library(rstanarm)
options(mc.cores = parallel::detectCores())
library(MCMCvis)
library(mcmcplots)
library(bayesplot)
```



# Run MCMC  --------

#	Move to the folder with the JAGS code
```{r}
setwd(model.folder)
```

# Choose features of MCMC --------
#   the number of chains
#   the number of iterations to burn-in, 
#	  the total number of iterations 
```{r}
n.chains = 4
n.warmup = 1000
n.iters.per.chain.after.warmup = 5000
n.iters.total.per.chain = n.iters.per.chain.after.warmup+n.warmup
```

# Fit the model in stan ------
```{r}
fitted.model <- stan_lmer(
  gain ~ 1+ stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1 | course_id),
  data=data.for.stan2,
  prior_intercept = normal(35, 30, autoscale = FALSE),
  prior = normal(0, 30, autoscale = FALSE),
  prior_aux = exponential(1, autoscale = FALSE),
  algorithm="sampling",
  chains = n.chains,
  iter = n.iters.total.per.chain,
  warmup = n.warmup,
  diagnostic_file = "model.multiple.regression.df.csv"
)
#gain_phys <- gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) +  (1|course_id))})

```

# Convergence Assessment --------

# Create a subfolder for it
```{r}
convergence.folder <- paste(model.folder, "Convergence Assessment/", sep="")
dir.create(convergence.folder)


# Move to it
setwd(convergence.folder)


# convert draws to mcmc.list
draws.as.mcmc.list <- MCMCchains(fitted.model, 
                  mcmc.list = TRUE)


# Define the names of parameters to use for convergence assessment
parameters.for.convergence <- colnames(as.matrix(draws.as.mcmc.list))
parameters.for.convergence <- parameters.for.convergence[!is.element(parameters.for.convergence, c("mean_PPD", "log-posterior"))]

# Define the draws to analyze
draws.to.analyze <- draws.as.mcmc.list

# Plot the results
# histogram, densities, and autocorrelations
mcmcplot(
  mcmcout = draws.to.analyze,
  parms = parameters.for.convergence,
  dir = getwd(),
  style="plain",
  filename = "MCMC Plots for Convergence Assessment"
)
```

# Plot R-hat (Gelman-Rubin) diagnostics
# Open a plot
```{r}
png(paste0("Rhat Plot", ".png"))

# Form the plot
gelman.plot(draws.to.analyze)


# Close the plot
dev.off()
```

# Posterior Summary --------


# Create a subfolder for it
```{r}
posterior.summary.folder <- paste(model.folder, "Summary of Posterior/", sep="")
dir.create(posterior.summary.folder)

# Move to it
setwd(posterior.summary.folder)


# Look at some diagnostics to confirm want to proceed
summary(fitted.model)


# Decide on the burn-in 
n.burnin=0 

# Define the draws to analyze
draws.to.analyze <- window(draws.as.mcmc.list,
                           start=n.burnin+1)




# Compute R squared
R.squared <- bayes_R2(fitted.model)

# Combine R squared with other draws from MCMC
draws.to.analyze.as.one.list <- as.mcmc(do.call(rbind,draws.to.analyze), R.squared) 

# drop extraneous variables
draws.to.analyze.as.data.frame <- cbind(data.frame(draws.to.analyze.as.one.list), R.squared)
draws.to.analyze.as.data.frame <- subset(draws.to.analyze.as.data.frame, select=-c(mean_PPD, log.posterior))

# convert to mcmc object
draws.to.analyze <- as.mcmc(draws.to.analyze.as.data.frame)
colnames(draws.to.analyze)[1] <- "Intercept"

# Define the parameters to summarize
parameters.to.summarize <- colnames(draws.to.analyze)

# convert to an mcmc.list for functions below
draws.to.analyze <- as.mcmc.list(draws.to.analyze)



# Plot posterior densities
# Open a plot
png(paste0("Density Plot", ".png"))

# Form the plot
color_scheme_set("purple")
mcmc_dens(
  draws.to.analyze,
  pars = parameters.to.summarize
)

# Close the plot
dev.off()



# Plot posterior densities with summaries
# Open a plot
png(paste0("Density Plot with Summaries", ".png"))

# Form the plot
mcmc_areas(
  draws.to.analyze,
  pars = parameters.to.summarize,
  prob = 0.95, # 95% intervals
  prob_outer = 1, # 100% coverage
  point_est = "mean"
)

# Close the plot
dev.off()
```

# Plot posterior densities with summaries for select parameters
# Open a plot
png(paste0("Density Plot with Summaries for Slopes", ".png"))

# Form the plot
mcmc_areas(
  draws.to.analyze,
  pars = c("gend_URM", "asian_no_int","black_no_int", "hispanic_no_int"),
  prob = 0.95, # 95% intervals
  prob_outer = 1, # 100% coverage
  point_est = "mean"
)

# Close the plot
dev.off()

```{r}
# Plot posterior scatterplot matrix
# Open a plot
png(paste0("Scatterplot Matrix Plot", ".png"))

# Form the plot
# Note that each bivariate plot uses half the chains
color_scheme_set("purple")
mcmc_pairs(
  draws.to.analyze,
  pars = parameters.to.summarize,
)

# Close the plot
dev.off()

```



# Compute the summary statistics
```{r}
summary.statistics <- MCMCsummary(
  draws.to.analyze,
  params = parameters.to.summarize,
  HPD=TRUE,
  Rhat=FALSE, # won't compute because had to combine to one chain
  round=2, 
  func=median, 
  func_name = "median"
)

# Write out the summary statistics
file.name="Summary Statistics.csv"
write.csv(
  x=summary.statistics,
  file=file.name
)
```

