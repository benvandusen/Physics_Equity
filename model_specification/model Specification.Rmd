---
title: "Equity analysis"
output: html_document
---

Load stuff (There are some packages that we don't need here, but I didn't clean them up. Sorry.)
```{r message=FALSE, warning=FALSE}
#load("~/hmi_data_1_10_19")
#load("~/Physics_Equity/hmifall2018_m10_better")
#load("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity_new/hmifall2018_m10_better")
load("~/hmi_1_23_19")
library("cAIC4")
library("MuMIn")
library(tidyr)
library("ggplot2")
library(gvlma)
library("HLMdiag")
library("DHARMa")
library("car") #for the Levene test which we will not discuss here
library("Matrix")
library(mitools)
library(stargazer)
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug
library(kableExtra)
plot_col <- c('#66c2a5', '#fc8d62', '#8da0cb')
#cbbpalette <- c('#000000','#E69F00','#56B4E9')
cbbpalette <- c( "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", 
    "#CC79A7","#000000", "#F0E442") #colorblind and grayscale friendly.
```

Creating mitml and extra variables
```{r}
#df_full <- complete(hmi.fall.2018)
#str(df_full)
MIdata<-mids2mitml.list(hmi_1_23_19) #converts file type
thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  temp <- left_join(temp,class_means,global_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$race_other_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)
  
```

Create time series data set
```{r message=FALSE, warning=FALSE}
MIdata3<-mids2mitml.list(hmi_1_23_19) #converts file type

for (i in 1:10){
  temp <- MIdata3[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  temp <- left_join(temp,class_means,global_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$race_other_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
    temp$score <- temp$pre_score
  temp$test <- 0
  temp$student <- seq.int(nrow(temp))
  temp <- subset(temp,select=-c(pre_score,post_score))
  thing[[i]] <- temp
  }
temp_pre3 <- as.mitml.list(thing)

thing <- list()
for (i in 1:10){
  temp <- MIdata3[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  temp <- left_join(temp,class_means,global_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$race_other_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
    temp$score <- temp$post_score
  temp$test <- 1
  temp$student <- seq.int(nrow(temp))
  temp <- subset(temp,select=-c(pre_score,post_score))
  thing[[i]] <- temp
  }
temp_post3 <- as.mitml.list(thing)

MIdata3 <- as.mitml.list(rbind.mitml.list(temp_pre3, temp_post3))


```

Best model dredge function
```{r}

best_mods_dred_function <- function(dredge_list,N){

temp<- dredge_list[[1]]
temp$rownames <- rownames(temp)
long_dredge <- temp
for (i in 2:length(dredge_list)) {
temp<- dredge_list[[i]]
temp$rownames <- rownames(temp)
long_dredge <- bind_rows(long_dredge,temp)  
}

dred_sum <- long_dredge %>% group_by(rownames) %>% summarize(delta_mean = mean(delta),
                                                             AICc_mean = mean(AICc))
dred_sum$rank <- rank(dred_sum$delta_mean)

temp <- dredge_list[[1]]
temp$rownames <- rownames(temp)

best_models <- temp[temp$rownames %in% dred_sum$rownames[dred_sum$rank<=N]]
best_models <- left_join(dred_sum[dred_sum$rank<=N,],best_models,  by="rownames")
return(best_models)
}
```

dredge 2 level
```{r}
options(na.action = "na.fail")
#gain8 <- with(MIdata,(lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))))

dredge <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id)))})
#intro_mod_dredge <- glmer(m_all, data=red_introPhys,family = binomial)
#intro_dredge <- dredge(intro_mod_dredge)

dredge_small <- best_mods_dred_function(dredge,100)

model.sel(dredge[[1]], rank=AIC)
#best model is (gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))
save(dredge_small, file="dredge_small")
```

dredge 3 level
```{r}
options(na.action = "na.fail")
#gain8 <- with(MIdata,(lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))))

dredge3 <- with(MIdata3,{dredge(lmer(score ~1 + test*(stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture) +  (1|course_id:student_id)))})
#intro_mod_dredge <- glmer(m_all, data=red_introPhys,family = binomial)
#intro_dredge <- dredge(intro_mod_dredge)
model.sel3(dredge[[1]], rank=AIC)
#best model is (gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))
save(dredge, file="dredge")
```

Stat significance model selection
```{r}
gain_full <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))})
testEstimates(gain_full, var.comp=TRUE)
```

running models for model selection writing
```{r}
gain_ss <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture +  (1|course_id))})

gain_ve <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture + (1|course_id))})

gain_ic <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))})

testEstimates(gain_ss, var.comp=TRUE)
testEstimates(gain_ve, var.comp=TRUE)
testEstimates(gain_ic, var.comp=TRUE)
```

3-level models models selection 
```{r}
gain_ss3 <- with(MIdata3,{lmer(score ~1 + stud_pre_cent + retake + test*(gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture) +  (1|course_id:student_id))})

gain_ve3 <- with(MIdata3,{lmer(score~1 + test*(stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture) + (1|course_id:student_id))})

gain_ic3 <- with(MIdata3,{lmer(score ~1 + test*(stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture) +  (1|course_id:student_id))})

testEstimates(gain_ss3, var.comp=TRUE)
testEstimates(gain_ve3, var.comp=TRUE)
testEstimates(gain_ic3, var.comp=TRUE)
```

The next two blocks make the figures 
```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```

graph for SS
```{r}
#     c(I,pre,R,F, A,B,H,O,P ,l)
WML = c(1,0,0,0, 0,0,0,0,0, 1)
WFL = c(1,0,0,1, 0,0,0,0,0, 1)

AML = c(1,0,0,0, 1,0,0,0,0, 1)
AFL = c(1,0,0,1, 1,0,0,0,0, 1)

BML = c(1,0,0,0, 0,1,0,0,0, 1)
BFL = c(1,0,0,1, 0,1,0,0,0, 1)

HML = c(1,0,0,0, 0,0,1,0,0, 1)
HFL = c(1,0,0,1, 0,0,1,0,0, 1)

OML = c(1,0,0,0, 0,0,0,1,0, 1)
OFL = c(1,0,0,1, 0,0,0,1,0, 1)

PML = c(1,0,0,0, 0,0,0,0,1, 1)
PFL = c(1,0,0,1, 0,0,0,0,1, 1)


contrast_forms_modss <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL
                      )

contrast_ss_est <- pool_and_cov_diffwm(gain_ss,contrast_forms_modss)
unique(contrast_ss_est$race)

contrast_ss_est$race <- factor(contrast_ss_est$race, levels = c("Black", "Hispanic", "Asian",    "White"))
contrast_ss_est$gender <- factor(contrast_ss_est$gender, levels = c("Women", "Men"))

ggplot(data=contrast_ss_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ss.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ss_est[c(1,2,6,7)], digits = 2)
```
graph for VE
```{r}
#     c(I,pre,reta, F,A,B, H,O,P, l,fa,fb, fh,fo,fp)
WML = c(1,0,0, 0,0,0, 0,0,0, 1,0,0, 0,0,0)
WFL = c(1,0,0, 1,0,0, 0,0,0, 1,0,0, 0,0,0)

AML = c(1,0,0, 0,1,0, 0,0,0, 1,0,0, 0,0,0)
AFL = c(1,0,0, 1,1,0, 0,0,0, 1,1,0, 0,0,0)

BML = c(1,0,0, 0,0,1, 0,0,0, 1,0,0, 0,0,0)
BFL = c(1,0,0, 1,0,1, 0,0,0, 1,0,1, 0,0,0)

HML = c(1,0,0, 0,0,0, 1,0,0, 1,0,0, 0,0,0)
HFL = c(1,0,0, 1,0,0, 1,0,0, 1,0,0, 1,0,0)

OML = c(1,0,0, 0,0,0, 0,1,0, 1,0,0, 0,0,0)
OFL = c(1,0,0, 1,0,0, 0,1,0, 1,0,0, 0,1,0)

PML = c(1,0,0, 0,0,0, 0,0,1, 1,0,0, 0,0,0)
PFL = c(1,0,0, 1,0,0, 0,0,1, 1,0,0, 0,0,1)


contrast_forms_modve <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL
                          )

contrast_ve_est <- pool_and_cov_diffwm(gain_ve,contrast_forms_modve)
unique(contrast_ve_est$race)

contrast_ve_est$race <- factor(contrast_ve_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))
contrast_ve_est$gender <- factor(contrast_ve_est$gender, levels = c("Women", "Men"))

ggplot(data=contrast_ve_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ve.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ve_est[c(1,2,6,7)], digits = 2)
```


graph for IC
```{r} 
#(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + retake + (1 |course_id))

#     c(I,pre,reta, F, A,B,H,O,P, L, fa,fb,fh,fo,fp, fl, al,bl,hl,ol,pl, fal,fbl,fhl,frl,fpl)
WML = c(1,0,0, 0, 0,0,0,0,0, 1, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFL = c(1,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0,  0,0,0,0,0)

AML = c(1,0,0, 0, 1,0,0,0,0, 1, 0,0,0,0,0, 0, 1,0,0,0,0,  0,0,0,0,0)
AFL = c(1,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0,  1,0,0,0,0)

BML = c(1,0,0, 0, 0,1,0,0,0, 1, 0,0,0,0,0, 0, 0,1,0,0,0,  0,0,0,0,0)
BFL = c(1,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0,  0,1,0,0,0)

HML = c(1,0,0, 0, 0,0,1,0,0, 1, 0,0,0,0,0, 0, 0,0,1,0,0,  0,0,0,0,0)
HFL = c(1,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0,  0,0,1,0,0)

OML = c(1,0,0, 0, 0,0,0,1,0, 1, 0,0,0,0,0, 0, 0,0,0,1,0,  0,0,0,0,0)
OFL = c(1,0,0, 1, 0,0,0,1,0, 1, 0,0,0,1,0, 1, 0,0,0,1,0,  0,0,0,1,0)

PML = c(1,0,0, 0, 0,0,0,0,1, 1, 0,0,0,0,0, 0, 0,0,0,0,1,  0,0,0,0,0)
PFL = c(1,0,0, 1, 0,0,0,0,1, 1, 0,0,0,0,1, 1, 0,0,0,0,1,  0,0,0,0,1)



contrast_forms_modic <- rbind('White Men Lecture'=WML,'White Women Lecture'=WFL,
                              'Black Men Lecture'=BML, 'Black Women Lecture'=BFL,
                              'Asian Men Lecture'=AML,'Asian Women Lecture'=AFL,
                              'Hispanic Men Lecture'=HML,'Hispanic Women Lecture'=HFL
                             )

#contrast_forms_modic_full <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
#                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
###                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
#                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
#                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
#                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
#                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
#                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC
#                          )

contrast_gic_est <- pool_and_cov_diffwm(gain_ic,contrast_forms_modic)
#contrast_gic_est$instruction <- factor(contrast_gic_est$instruction, levels = c("Lecture","Collab"))
contrast_gic_est$race <- factor(contrast_gic_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))
contrast_gic_est$gender <- factor(contrast_gic_est$gender, levels = c("Women", "Men"))

ggplot(data=contrast_gic_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ic.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ve_est[c(1,2,6,7)], digits = 2)
```

Combined graph for SS
```{r}
#     c(I,pre,R,F, A,B,H,O,P ,l)
WML = c(1,0,0,0, 0,0,0,0,0, 1)
WFL = c(1,0,0,1, 0,0,0,0,0, 1)

AML = c(1,0,0,0, 1,0,0,0,0, 1)
AFL = c(1,0,0,1, 1,0,0,0,0, 1)

BML = c(1,0,0,0, 0,1,0,0,0, 1)
BFL = c(1,0,0,1, 0,1,0,0,0, 1)

HML = c(1,0,0,0, 0,0,1,0,0, 1)
HFL = c(1,0,0,1, 0,0,1,0,0, 1)


#     c(I,pre,R,F, A,B,H,O,P ,l)
WMLc = c(1,0,0,0, 0,0,0,0,0, 0)
WFLc = c(1,0,0,1, 0,0,0,0,0, 0)

AMLc = c(1,0,0,0, 1,0,0,0,0, 0)
AFLc = c(1,0,0,1, 1,0,0,0,0, 0)

BMLc = c(1,0,0,0, 0,1,0,0,0, 0)
BFLc = c(1,0,0,1, 0,1,0,0,0, 0)

HMLc = c(1,0,0,0, 0,0,1,0,0, 0)
HFLc = c(1,0,0,1, 0,0,1,0,0, 0)



contrast_forms_modss <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL,
                          'White Men Collab'=WMLc,  
                          'White Women Collab'=WFLc,
                          'Black Men Collab'=BMLc,  
                          'Black Women Collab'=BFLc,
                          'Asian Men Collab'=AMLc, 
                          'Asian Women Collab'=AFLc,
                          'Hispanic Men Collab'=HMLc, 
                          'Hispanic Women Collab'=HFLc
                      )

contrast_ss_est <- pool_and_cov_diffwm(gain_ss,contrast_forms_modss)

contrast_ss_est$race <- factor(contrast_ss_est$race, levels = c("Black", "Hispanic", "Asian",    "White"))

contrast_ss_est$gender <- c("Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab")
contrast_ss_est$gender <- factor(contrast_ss_est$gender, levels = c("Women","Men","Women Collab","Men Collab"))

ggplot(data=contrast_ss_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ss_combo.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ss_est[c(1,2,6,7)], digits = 2)
```

Combined graph for VE
```{r}
#     c(I,pre,reta, F,A,B, H,O,P, l,fa,fb, fh,fo,fp)
WML = c(1,0,0, 0,0,0, 0,0,0, 1,0,0, 0,0,0)
WFL = c(1,0,0, 1,0,0, 0,0,0, 1,0,0, 0,0,0)

AML = c(1,0,0, 0,1,0, 0,0,0, 1,0,0, 0,0,0)
AFL = c(1,0,0, 1,1,0, 0,0,0, 1,1,0, 0,0,0)

BML = c(1,0,0, 0,0,1, 0,0,0, 1,0,0, 0,0,0)
BFL = c(1,0,0, 1,0,1, 0,0,0, 1,0,1, 0,0,0)

HML = c(1,0,0, 0,0,0, 1,0,0, 1,0,0, 0,0,0)
HFL = c(1,0,0, 1,0,0, 1,0,0, 1,0,0, 1,0,0)

WMLc = c(1,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0)
WFLc = c(1,0,0, 1,0,0, 0,0,0, 0,0,0, 0,0,0)

AMLc = c(1,0,0, 0,1,0, 0,0,0, 0,0,0, 0,0,0)
AFLc = c(1,0,0, 1,1,0, 0,0,0, 0,1,0, 0,0,0)

BMLc = c(1,0,0, 0,0,1, 0,0,0, 0,0,0, 0,0,0)
BFLc = c(1,0,0, 1,0,1, 0,0,0, 0,0,1, 0,0,0)

HMLc = c(1,0,0, 0,0,0, 1,0,0, 0,0,0, 0,0,0)
HFLc = c(1,0,0, 1,0,0, 1,0,0, 0,0,0, 1,0,0)



contrast_forms_modve <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL,
                          'White Men Collab'=WMLc,  
                          'White Women Collab'=WFLc,
                          'Black Men Collab'=BMLc,  
                          'Black Women Collab'=BFLc,
                          'Asian Men Collab'=AMLc, 
                          'Asian Women Collab'=AFLc,
                          'Hispanic Men Collab'=HMLc, 
                          'Hispanic Women Collab'=HFLc
                      )
                       

contrast_ve_est <- pool_and_cov_diffwm(gain_ve,contrast_forms_modve)

contrast_ve_est$race <- factor(contrast_ve_est$race, levels = c("Black", "Hispanic", "Asian",    "White"))
contrast_ve_est$gender <- c("Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab")
contrast_ve_est$gender <- factor(contrast_ve_est$gender, levels = c("Women","Men","Women Collab","Men Collab"))

ggplot(data=contrast_ve_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ve_combo.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ve_est[c(1,2,6,7)], digits = 2)
```

combined graph for IC
```{r} 
#(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + retake + (1 |course_id))

#     c(I,pre,reta, F, A,B,H,O,P, L, fa,fb,fh,fo,fp, fl, al,bl,hl,ol,pl, fal,fbl,fhl,frl,fpl)
WML = c(1,0,0, 0, 0,0,0,0,0, 1, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFL = c(1,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0,  0,0,0,0,0)

AML = c(1,0,0, 0, 1,0,0,0,0, 1, 0,0,0,0,0, 0, 1,0,0,0,0,  0,0,0,0,0)
AFL = c(1,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0,  1,0,0,0,0)

BML = c(1,0,0, 0, 0,1,0,0,0, 1, 0,0,0,0,0, 0, 0,1,0,0,0,  0,0,0,0,0)
BFL = c(1,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0,  0,1,0,0,0)

HML = c(1,0,0, 0, 0,0,1,0,0, 1, 0,0,0,0,0, 0, 0,0,1,0,0,  0,0,0,0,0)
HFL = c(1,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0,  0,0,1,0,0)

WMLc = c(1,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFLc = c(1,0,0, 1, 0,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

AMLc = c(1,0,0, 0, 1,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
AFLc = c(1,0,0, 1, 1,0,0,0,0, 0, 1,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

BMLc = c(1,0,0, 0, 0,1,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
BFLc = c(1,0,0, 1, 0,1,0,0,0, 0, 0,1,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

HMLc = c(1,0,0, 0, 0,0,1,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
HFLc = c(1,0,0, 1, 0,0,1,0,0, 0, 0,0,1,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)




contrast_forms_modic <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL,
                          'White Men Collab'=WMLc,  
                          'White Women Collab'=WFLc,
                          'Black Men Collab'=BMLc,  
                          'Black Women Collab'=BFLc,
                          'Asian Men Collab'=AMLc, 
                          'Asian Women Collab'=AFLc,
                          'Hispanic Men Collab'=HMLc, 
                          'Hispanic Women Collab'=HFLc
                      )

contrast_ic_est <- pool_and_cov_diffwm(gain_ic,contrast_forms_modic)
#contrast_gic_est$instruction <- factor(contrast_gic_est$instruction, levels = c("Lecture","Collab"))
contrast_ic_est$race <- factor(contrast_ic_est$race, levels = c("Black", "Hispanic", "Asian",    "White"))
contrast_ic_est$gender <- c("Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab")
contrast_ic_est$gender <- factor(contrast_ic_est$gender, levels = c("Women","Men","Women Collab","Men Collab"))

ggplot(data=contrast_ic_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ic_combo.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ve_est[c(1,2,6,7)], digits = 2)
```

Graph of shift to collab SS
```{r}
#     c(I,pre,R,F, A,B,H,O,P ,l)
WMCss = c(0,0,0,0, 0,0,0,0,0, -1)
WFCss = c(0,0,0,0, 0,0,0,0,0, -1)

AMCss = c(0,0,0,0, 0,0,0,0,0, -1)
AFCss = c(0,0,0,0, 0,0,0,0,0, -1)

BMCss = c(0,0,0,0, 0,0,0,0,0, -1)
BFCss = c(0,0,0,0, 0,0,0,0,0, -1)

HMCss = c(0,0,0,0, 0,0,0,0,0, -1)
HFCss = c(0,0,0,0, 0,0,0,0,0, -1)

OMCss = c(0,0,0,0, 0,0,0,0,0, -1)
OFCss = c(0,0,0,0, 0,0,0,0,0, -1)

PMCss = c(0,0,0,0, 0,0,0,0,0, -1)
PFCss = c(0,0,0,0, 0,0,0,0,0, -1)


contrast_forms_modCss <- rbind('White Men'=WMCss,  
                          'White Women'=WFCss,
                          'Black Men'=BMCss,  
                          'Black Women'=BFCss,
                          'Asian Men'=AMCss, 
                          'Asian Women'=AFCss,
                          'Hispanic Men'=HMCss, 
                          'Hispanic Women'=HFCss
                          )

contrast_Css_est <- pool_and_cov_diffwm(gain_ss,contrast_forms_modCss)
unique(contrast_Css_est$race)

contrast_Css_est$race <- factor(contrast_Css_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))
contrast_Css_est$gender <- factor(contrast_Css_est$gender, levels = c("Women", "Men"))

ggplot(data=contrast_Css_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figuresmod_Css.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ss_est[c(1,2,6,7)], digits = 2)
```

Graph of shift to collab VE
```{r}
#     c(I,pre,reta, F,A,B, H,O,P, l,fa,fb, fh,fo,fp)
WMCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)
WFCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)

AMCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)
AFCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)

BMCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)
BFCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)

HMCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)
HFCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)

OMCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)
OFCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)

PMCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)
PFCve = c(0,0,0, 0,0,0, 0,0,0, -1,0,0, 0,0,0)


contrast_forms_modCve <- rbind('White Men'=WMCve,  
                          'White Women'=WFCve,
                          'Black Men'=BMCve,  
                          'Black Women'=BFCve,
                          'Asian Men'=AMCve, 
                          'Asian Women'=AFCve,
                          'Hispanic Men'=HMCve, 
                          'Hispanic Women'=HFCve
                        )

contrast_Cve_est <- pool_and_cov_diffwm(gain_ve,contrast_forms_modCve)
unique(contrast_Cve_est$race)

contrast_Cve_est$race <- factor(contrast_Cve_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))
contrast_Cve_est$gender <- factor(contrast_Cve_est$gender, levels = c("Women", "Men"))

ggplot(data=contrast_Cve_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_Cve.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ss_est[c(1,2,6,7)], digits = 2)
```

Graph of shift to collab IC
```{r}
#     c(I,pre,reta, F, A,B,H,O,P, L, fa,fb,fh,fo,fp, fl, al,bl,hl,ol,pl, fal,fbl,fhl,frl,fpl)
WMCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, -1, 0,0,0,0,0,  0,0,0,0,0)

AMCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, 0, -1,0,0,0,0,  0,0,0,0,0)
AFCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, -1, -1,0,0,0,0,  -1,0,0,0,0)

BMCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, 0, 0,-1,0,0,0,  0,0,0,0,0)
BFCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, -1, 0,-1,0,0,0,  0,-1,0,0,0)

HMCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, 0, 0,0,-1,0,0,  0,0,0,0,0)
HFCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, -1, 0,0,-1,0,0,  0,0,-1,0,0)

OMCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, 0, 0,0,0,-1,0,  0,0,0,0,0)
OFCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, -1, 0,0,0,-1,0,  0,0,0,-1,0)

PMCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, 0, 0,0,0,0,-1,  0,0,0,0,0)
PFCic = c(0,0,0, 0, 0,0,0,0,0, -1, 0,0,0,0,0, -1, 0,0,0,0,-1,  0,0,0,0,-1)


contrast_forms_modCic <- rbind('White Men'=WMCic,  
                          'White Women'=WFCic,
                          'Black Men'=BMCic,  
                          'Black Women'=BFCic,
                          'Asian Men'=AMCic, 
                          'Asian Women'=AFCic,
                          'Hispanic Men'=HMCic, 
                          'Hispanic Women'=HFCic
                          )

contrast_Cic_est <- pool_and_cov_diffwm(gain_ic,contrast_forms_modCic)
unique(contrast_Cic_est$race)

contrast_Cic_est$race <- factor(contrast_Cic_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))
contrast_Cic_est$gender <- factor(contrast_Cic_est$gender, levels = c("Women", "Men"))

ggplot(data=contrast_Cic_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_Cic.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ss_est[c(1,2,6,7)], digits = 2)
```