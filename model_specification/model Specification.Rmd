---
title: "Equity analysis"
output: html_document
---

Load stuff (There are some packages that we don't need here, but I didn't clean them up. Sorry.)
```{r message=FALSE, warning=FALSE}
#load("~/hmi_data_1_10_19")
#load("~/Physics_Equity/hmifall2018_m10_better")
#load("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity_new/hmifall2018_m10_better")
load("~/hmi_1_23_19")
library("cAIC4")
library("MuMIn")
library(tidyr)
library("ggplot2")
library(gvlma)
library("HLMdiag")
library("DHARMa")
library("car") #for the Levene test which we will not discuss here
library("Matrix")
library(mitools)
library(stargazer)
library(lme4)
library(lattice)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug
library(kableExtra)
plot_col <- c('#66c2a5', '#fc8d62', '#8da0cb')
#cbbpalette <- c('#000000','#E69F00','#56B4E9')
cbbpalette <- c( "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", 
    "#CC79A7","#000000", "#F0E442") #colorblind and grayscale friendly.
```

Creating mitml and extra variables
```{r}
#df_full <- complete(hmi.fall.2018)
#str(df_full)
MIdata<-mids2mitml.list(hmi_1_23_19) #converts file type
thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  temp <- left_join(temp,class_means,global_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$race_other_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)
  
```

Create time series data set
```{r message=FALSE, warning=FALSE}
MIdata3<-mids2mitml.list(hmi_1_23_19) #converts file type

for (i in 1:10){
  temp <- MIdata3[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  temp <- left_join(temp,class_means,global_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$race_other_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
    temp$score <- temp$pre_score
  temp$test <- 0
  temp$student <- seq.int(nrow(temp))
  temp <- subset(temp,select=-c(pre_score,post_score))
  thing[[i]] <- temp
  }
temp_pre3 <- as.mitml.list(thing)

thing <- list()
for (i in 1:10){
  temp <- MIdata3[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  temp <- left_join(temp,class_means,global_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$race_other_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
    temp$score <- temp$post_score
  temp$test <- 1
  temp$student <- seq.int(nrow(temp))
  temp <- subset(temp,select=-c(pre_score,post_score))
  thing[[i]] <- temp
  }
temp_post3 <- as.mitml.list(thing)

MIdata3 <- as.mitml.list(rbind.mitml.list(temp_pre3, temp_post3))


```

Best model dredge function
```{r}

best_mods_dred_function <- function(dredge_list,N){

temp<- dredge_list[[1]]
temp$rownames <- rownames(temp)
long_dredge <- temp
for (i in 2:length(dredge_list)) {
temp<- dredge_list[[i]]
temp$rownames <- rownames(temp)
long_dredge <- bind_rows(long_dredge,temp)  
}

dred_sum <- long_dredge %>% group_by(rownames) %>% summarize(delta_mean = mean(delta),
                                                             AICc_mean = mean(AICc),
                                                             BIC_mean= mean(BIC),
                                                             ICOMP_mean = mean(ICOMP),
                                                             Cp_mean = mean(Cp))
dred_sum$rank <- rank(dred_sum$delta_mean)

temp <- dredge_list[[1]]
temp$rownames <- rownames(temp)

best_models <- temp[temp$rownames %in% dred_sum$rownames[dred_sum$rank<=N]]
best_models <- left_join(dred_sum[dred_sum$rank<=N,],best_models,  by="rownames")
return(best_models)
}
```

dredge 2 level
```{r}
options(na.action = "na.fail")
#gain8 <- with(MIdata,(lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))))

dredge <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id)), m.lim=c(18,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
#intro_mod_dredge <- glmer(m_all, data=red_introPhys,family = binomial)
#intro_dredge <- dredge(intro_mod_dredge)


dredge_small <- best_mods_dred_function(dredge,100)

model.sel(dredge[[1]], rank=AIC)
#best model is (gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))
save(dredge, file="dredge")
save(dredge_small, file="dredge_small")
```

Information criteria scores
```{r}
options(na.action = "na.fail")

dM1 <- with(MIdata,{dredge(lmer(gain ~1 +  (1|course_id)), m.lim=c(0,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM2 <- with(MIdata,{dredge(lmer(gain ~1 +  stud_pre_cent +   (1|course_id)), m.lim=c(1,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM3 <- with(MIdata,{dredge(lmer(gain ~1 +  stud_pre_cent + pre_mean_class + (1|course_id)), m.lim=c(2,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM4 <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake +  (1|course_id)), m.lim=c(2,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM5 <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + coll + (1|course_id)), m.lim=c(3,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM6 <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM + (1|course_id)), m.lim=c(4,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM7 <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)+ (1|course_id)), m.lim=c(9,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM8 <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)+ (1|course_id)), m.lim=c(8,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM9 <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)), m.lim=c(14,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM10 <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + coll*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)), m.lim=c(25,NA), extra = alist(AIC, BIC, ICOMP, Cp))})
dM11 <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + pre_mean_class + retake + coll*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)), m.lim=c(26,NA), extra = alist(AIC, BIC, ICOMP, Cp))})


best_M1 <- best_mods_dred_function(dM1,10)
best_M2 <- best_mods_dred_function(dM2,10)
best_M3 <- best_mods_dred_function(dM3,10)
best_M4 <- best_mods_dred_function(dM4,10)
best_M5 <- best_mods_dred_function(dM5,10)
best_M6 <- best_mods_dred_function(dM6,10)
best_M7 <- best_mods_dred_function(dM7,10)
best_M8 <- best_mods_dred_function(dM8,10)
best_M9 <- best_mods_dred_function(dM9,10)
best_M10 <- best_mods_dred_function(dM10,10)
best_M11 <- best_mods_dred_function(dM11,10)
```

dredge 3 level
```{r}
options(na.action = "na.fail")
#gain8 <- with(MIdata,(lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))))

dredge3 <- with(MIdata3,{dredge(lmer(score ~1 + test*(stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture) +  (1|course_id:student_id)))})
#intro_mod_dredge <- glmer(m_all, data=red_introPhys,family = binomial)
#intro_dredge <- dredge(intro_mod_dredge)
model.sel3(dredge[[1]], rank=AIC)
#best model is (gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))
save(dredge, file="dredge")
```

Model buildup
```{r}
M1 <- with(MIdata,{lmer(gain ~1 +  (1|course_id))})
M2 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent +  (1|course_id))})
M3 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + pre_mean_class + (1|course_id))})
M4 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake +  (1|course_id))})
M5 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + coll + (1|course_id))})
M6 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM + (1|course_id))})
M7 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})
M8 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})
M9 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})
M10 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + coll*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})
M11 <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + pre_mean_class + retake + coll*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})

testEstimates(M1, var.comp=TRUE)
testEstimates(M2, var.comp=TRUE)
testEstimates(M3, var.comp=TRUE)
testEstimates(M4, var.comp=TRUE)
testEstimates(M5, var.comp=TRUE)
testEstimates(M6, var.comp=TRUE)
testEstimates(M7, var.comp=TRUE)
testEstimates(M8, var.comp=TRUE)
testEstimates(M9, var.comp=TRUE)
testEstimates(M10, var.comp=TRUE)
testEstimates(M11, var.comp=TRUE)
```

R2
```{r}

R1 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 +  (1|course_id)))})
R2 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent +  (1|course_id)))})
R3 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + pre_mean_class + (1|course_id)))})
R4 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + retake +  (1|course_id)))})
R5 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + retake + coll + (1|course_id)))})
R6 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM + (1|course_id)))})
R7 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)))})
R8 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + retake + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)))})
R9 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + retake + coll + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)))})
R10 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + retake + coll*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)))})
R11 <- with(MIdata,{r.squaredGLMM(lmer(gain ~1 + stud_pre_cent + pre_mean_class + retake + coll*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)))})

library(popbio)

mean.list(R1)
mean.list(R2)
mean.list(R3)
mean.list(R4)
mean.list(R5)
mean.list(R6)
mean.list(R7)
mean.list(R8)
mean.list(R9)
mean.list(R10)
mean.list(R11)
```

running models for model selection writing
```{r}
gain_ss <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) +  (1|course_id))})

gain_ve <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + coll + (1|course_id))})

gain_ic <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*coll +  (1|course_id))})

gain_ap <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + pre_mean_class + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*coll +  (1|course_id))})

testEstimates(gain_ss, var.comp=TRUE)
testEstimates(gain_ve, var.comp=TRUE)
testEstimates(gain_ic, var.comp=TRUE)
testEstimates(gain_ap, var.comp=TRUE)
```

3-level models selection 
```{r}
gain_ss3 <- with(MIdata3,{lmer(score ~1 + stud_pre_cent + retake + test*(gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + coll) +  (1|course_id:student_id))})

gain_ve3 <- with(MIdata3,{lmer(score~1 + test*(stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + coll) + (1|course_id:student_id))})

gain_ic3 <- with(MIdata3,{lmer(score ~1 + test*(stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*coll) +  (1|course_id:student_id))})

testEstimates(gain_ss3, var.comp=TRUE)
testEstimates(gain_ve3, var.comp=TRUE)
testEstimates(gain_ic3, var.comp=TRUE)
```

The next two blocks make the figures 
```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```


graph for AP
```{r} 
#(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + pre_mean_class + retake + (1 |course_id))

#     c(I,pre,pre_c,reta, F, A,B,H,O,P, L, fa,fb,fh,fo,fp, fl, al,bl,hl,ol,pl, fal,fbl,fhl,frl,fpl)
WML = c(1,0,0,0, 0, 0,0,0,0,0, 1, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFL = c(1,0,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0,  0,0,0,0,0)

AML = c(1,0,0,0, 0, 1,0,0,0,0, 1, 0,0,0,0,0, 0, 1,0,0,0,0,  0,0,0,0,0)
AFL = c(1,0,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0,  1,0,0,0,0)

BML = c(1,0,0,0, 0, 0,1,0,0,0, 1, 0,0,0,0,0, 0, 0,1,0,0,0,  0,0,0,0,0)
BFL = c(1,0,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0,  0,1,0,0,0)

HML = c(1,0,0,0, 0, 0,0,1,0,0, 1, 0,0,0,0,0, 0, 0,0,1,0,0,  0,0,0,0,0)
HFL = c(1,0,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0,  0,0,1,0,0)

OML = c(1,0,0,0, 0, 0,0,0,1,0, 1, 0,0,0,0,0, 0, 0,0,0,1,0,  0,0,0,0,0)
OFL = c(1,0,0,0, 1, 0,0,0,1,0, 1, 0,0,0,1,0, 1, 0,0,0,1,0,  0,0,0,1,0)

PML = c(1,0,0,0, 0, 0,0,0,0,1, 1, 0,0,0,0,0, 0, 0,0,0,0,1,  0,0,0,0,0)
PFL = c(1,0,0,0, 1, 0,0,0,0,1, 1, 0,0,0,0,1, 1, 0,0,0,0,1,  0,0,0,0,1)



contrast_forms_modic <- rbind('White Men Lecture'=WML,'White Women Lecture'=WFL,
                              'Black Men Lecture'=BML, 'Black Women Lecture'=BFL,
                              'Asian Men Lecture'=AML,'Asian Women Lecture'=AFL,
                              'Hispanic Men Lecture'=HML,'Hispanic Women Lecture'=HFL
                             )

#contrast_forms_modic_full <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
#                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
###                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
#                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
#                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
#                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
#                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
#                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC
#                          )

contrast_gap_est <- pool_and_cov_diffwm(gain_ap,contrast_forms_modic)
#contrast_gic_est$instruction <- factor(contrast_gic_est$instruction, levels = c("Lecture","Collab"))
contrast_gap_est$race <- factor(contrast_gap_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))
contrast_gap_est$gender <- factor(contrast_gap_est$gender, levels = c("Women", "Men"))

ggplot(data=contrast_gap_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ap.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_ve_est[c(1,2,6,7)], digits = 2)
```

Combined graph for SS
```{r}
#     c(I,pre,R,F, A,B,H,O,P)
WMLc = c(1,0,0,0, 0,0,0,0,0)
WFLc = c(1,0,0,1, 0,0,0,0,0)

AMLc = c(1,0,0,0, 1,0,0,0,0)
AFLc = c(1,0,0,1, 1,0,0,0,0)

BMLc = c(1,0,0,0, 0,1,0,0,0)
BFLc = c(1,0,0,1, 0,1,0,0,0)

HMLc = c(1,0,0,0, 0,0,1,0,0)
HFLc = c(1,0,0,1, 0,0,1,0,0)


#     c(I,pre,R,F, A,B,H,O,P)
WML = c(1,0,0,0, 0,0,0,0,0)
WFL = c(1,0,0,1, 0,0,0,0,0)

AML = c(1,0,0,0, 1,0,0,0,0)
AFL = c(1,0,0,1, 1,0,0,0,0)

BML = c(1,0,0,0, 0,1,0,0,0)
BFL = c(1,0,0,1, 0,1,0,0,0)

HML = c(1,0,0,0, 0,0,1,0,0)
HFL = c(1,0,0,1, 0,0,1,0,0)



contrast_forms_modss <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL
                    
                      )

contrast_ss_est <- pool_and_cov_diffwm(gain_ss,contrast_forms_modss)

contrast_ss_est$race <- factor(contrast_ss_est$race, levels = c("Black", "Hispanic", "Asian",    "White"))

contrast_ss_est$gender <- c("Men","Women","Men","Women", "Men","Women", "Men","Women")
contrast_ss_est$gender <- factor(contrast_ss_est$gender, levels = c("Women","Men","Women Collab","Men Collab"))

ggplot(data=contrast_ss_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(breaks=seq(0, 26, 5),limits=c(0,26))+
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette,) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ss_combo.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")

ggplot(data=contrast_ss_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "none",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(breaks=seq(0, 26, 5),limits=c(0,26))+
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette,) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ss_combo_nl.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
#kable(contrast_ss_est[c(1,2,6,7)], digits = 2)
```

Combined graph for VE
```{r}
#     c(I,pre,reta, F,A,B, H,O,P, c)
WMLc = c(1,0,0, 0,0,0, 0,0,0, 1)
WFLc = c(1,0,0, 1,0,0, 0,0,0, 1)

AMLc = c(1,0,0, 0,1,0, 0,0,0, 1)
AFLc = c(1,0,0, 1,1,0, 0,0,0, 1)

BMLc = c(1,0,0, 0,0,1, 0,0,0, 1)
BFLc = c(1,0,0, 1,0,1, 0,0,0, 1)

HMLc = c(1,0,0, 0,0,0, 1,0,0, 1)
HFLc = c(1,0,0, 1,0,0, 1,0,0, 1)

WML = c(1,0,0, 0,0,0, 0,0,0, 0)
WFL = c(1,0,0, 1,0,0, 0,0,0, 0)

AML = c(1,0,0, 0,1,0, 0,0,0, 0)
AFL = c(1,0,0, 1,1,0, 0,0,0, 0)

BML = c(1,0,0, 0,0,1, 0,0,0, 0)
BFL = c(1,0,0, 1,0,1, 0,0,0, 0)

HML = c(1,0,0, 0,0,0, 1,0,0, 0)
HFL = c(1,0,0, 1,0,0, 1,0,0, 0)



contrast_forms_modve <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL,
                          'White Men Collab'=WMLc,  
                          'White Women Collab'=WFLc,
                          'Black Men Collab'=BMLc,  
                          'Black Women Collab'=BFLc,
                          'Asian Men Collab'=AMLc, 
                          'Asian Women Collab'=AFLc,
                          'Hispanic Men Collab'=HMLc, 
                          'Hispanic Women Collab'=HFLc
                      )
                       

contrast_ve_est <- pool_and_cov_diffwm(gain_ve,contrast_forms_modve)

contrast_ve_est$race <- factor(contrast_ve_est$race, levels = c("Black", "Hispanic", "Asian",    "White"))
contrast_ve_est$gender <- c("Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab")
contrast_ve_est$gender <- factor(contrast_ve_est$gender, levels = c("Women","Men","Women Collab","Men Collab"))

ggplot(data=contrast_ve_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(breaks=seq(0, 26, 5),limits=c(0,26))+
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ve_combo.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")

ggplot(data=contrast_ve_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "none",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(breaks=seq(0, 26, 5),limits=c(0,26))+
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ve_combo_nl.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
#kable(contrast_ve_est[c(1,2,6,7)], digits = 2)
```

combined graph for IC
```{r} 
#(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + retake + (1 |course_id))

#     c(I,pre,reta, F, A,B,H,O,P, L, fa,fb,fh,fo,fp, fl, al,bl,hl,ol,pl, fal,fbl,fhl,frl,fpl)
WMLc = c(1,0,0, 0, 0,0,0,0,0, 1, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFLc = c(1,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0,  0,0,0,0,0)

AMLc = c(1,0,0, 0, 1,0,0,0,0, 1, 0,0,0,0,0, 0, 1,0,0,0,0,  0,0,0,0,0)
AFLc = c(1,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0,  1,0,0,0,0)

BMLc = c(1,0,0, 0, 0,1,0,0,0, 1, 0,0,0,0,0, 0, 0,1,0,0,0,  0,0,0,0,0)
BFLc = c(1,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0,  0,1,0,0,0)

HMLc = c(1,0,0, 0, 0,0,1,0,0, 1, 0,0,0,0,0, 0, 0,0,1,0,0,  0,0,0,0,0)
HFLc = c(1,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0,  0,0,1,0,0)

WML = c(1,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFL = c(1,0,0, 1, 0,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

AML = c(1,0,0, 0, 1,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
AFL = c(1,0,0, 1, 1,0,0,0,0, 0, 1,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

BML = c(1,0,0, 0, 0,1,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
BFL = c(1,0,0, 1, 0,1,0,0,0, 0, 0,1,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

HML = c(1,0,0, 0, 0,0,1,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
HFL = c(1,0,0, 1, 0,0,1,0,0, 0, 0,0,1,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)




contrast_forms_modic <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL,
                          'White Men Collab'=WMLc,  
                          'White Women Collab'=WFLc,
                          'Black Men Collab'=BMLc,  
                          'Black Women Collab'=BFLc,
                          'Asian Men Collab'=AMLc, 
                          'Asian Women Collab'=AFLc,
                          'Hispanic Men Collab'=HMLc, 
                          'Hispanic Women Collab'=HFLc
                      )

contrast_ic_est <- pool_and_cov_diffwm(gain_ic,contrast_forms_modic)
#contrast_gic_est$instruction <- factor(contrast_gic_est$instruction, levels = c("Lecture","Collab"))
contrast_ic_est$race <- factor(contrast_ic_est$race, levels = c("Black", "Hispanic", "Asian",    "White"))
contrast_ic_est$gender <- c("Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab")
contrast_ic_est$gender <- factor(contrast_ic_est$gender, levels = c("Women","Men","Women Collab","Men Collab"))

ggplot(data=contrast_ic_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(breaks=seq(0, 26, 5),limits=c(0,26))+
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ic_combo.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")

ggplot(data=contrast_ic_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(breaks=seq(0, 26, 5),limits=c(0,26))+
    theme(legend.position = "none") +
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ic_combo_nl.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")

#kable(contrast_ve_est[c(1,2,6,7)], digits = 2)
```

combined graph for AP
```{r} 
#(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + retake + (1 |course_id))

#     c(I,pre,mpre,reta, F, A,B,H,O,P, L, fa,fb,fh,fo,fp, fl, al,bl,hl,ol,pl, fal,fbl,fhl,frl,fpl)
WMLc = c(1,0,0,0,  0, 0,0,0,0,0, 1, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFLc = c(1,0,0,0,   1, 0,0,0,0,0, 1, 0,0,0,0,0, 1, 0,0,0,0,0,  0,0,0,0,0)

AMLc = c(1,0,0,0,   0, 1,0,0,0,0, 1, 0,0,0,0,0, 0, 1,0,0,0,0,  0,0,0,0,0)
AFLc = c(1,0,0,0,   1, 1,0,0,0,0, 1, 1,0,0,0,0, 1, 1,0,0,0,0,  1,0,0,0,0)

BMLc = c(1,0,0,0,   0, 0,1,0,0,0, 1, 0,0,0,0,0, 0, 0,1,0,0,0,  0,0,0,0,0)
BFLc = c(1,0,0,0,   1, 0,1,0,0,0, 1, 0,1,0,0,0, 1, 0,1,0,0,0,  0,1,0,0,0)

HMLc = c(1,0,0,0,   0, 0,0,1,0,0, 1, 0,0,0,0,0, 0, 0,0,1,0,0,  0,0,0,0,0)
HFLc = c(1,0,0,0,   1, 0,0,1,0,0, 1, 0,0,1,0,0, 1, 0,0,1,0,0,  0,0,1,0,0)

WML = c(1,0,0,0,   0, 0,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
WFL = c(1,0,0,0,   1, 0,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

AML = c(1,0,0,0,   0, 1,0,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
AFL = c(1,0,0,0,   1, 1,0,0,0,0, 0, 1,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

BML = c(1,0,0,0,   0, 0,1,0,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
BFL = c(1,0,0,0,   1, 0,1,0,0,0, 0, 0,1,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)

HML = c(1,0,0,0,   0, 0,0,1,0,0, 0, 0,0,0,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)
HFL = c(1,0,0,0,   1, 0,0,1,0,0, 0, 0,0,1,0,0, 0, 0,0,0,0,0,  0,0,0,0,0)




contrast_forms_modic <- rbind('White Men'=WML,  
                          'White Women'=WFL,
                          'Black Men'=BML,  
                          'Black Women'=BFL,
                          'Asian Men'=AML, 
                          'Asian Women'=AFL,
                          'Hispanic Men'=HML, 
                          'Hispanic Women'=HFL,
                          'White Men Collab'=WMLc,  
                          'White Women Collab'=WFLc,
                          'Black Men Collab'=BMLc,  
                          'Black Women Collab'=BFLc,
                          'Asian Men Collab'=AMLc, 
                          'Asian Women Collab'=AFLc,
                          'Hispanic Men Collab'=HMLc, 
                          'Hispanic Women Collab'=HFLc
                      )

contrast_ap_est <- pool_and_cov_diffwm(gain_ap,contrast_forms_modic)
#contrast_gic_est$instruction <- factor(contrast_gic_est$instruction, levels = c("Lecture","Collab"))
contrast_ap_est$race <- factor(contrast_ap_est$race, levels = c("Black", "Hispanic", "Asian",    "White"))
contrast_ap_est$gender <- c("Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab", "Men","Men Collab","Women","Women Collab")
contrast_ap_est$gender <- factor(contrast_ap_est$gender, levels = c("Women","Men","Women Collab","Men Collab"))

ggplot(data=contrast_ap_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(breaks=seq(0, 26, 5),limits=c(0,26))+
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),       
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ap_combo.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")

ggplot(data=contrast_ap_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  theme(legend.position = "none") +
  scale_y_continuous(breaks=seq(0, 26, 5),limits=c(0,26))+
  scale_fill_manual(name="Gender",
                     breaks= c("Women","Men","Women Collab","Men Collab"),       
                     values=cbbpalette) 
ggsave("~/Physics_Equity/model_specification/Figures/mod_ap_combo_nl.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
#kable(contrast_ve_est[c(1,2,6,7)], digits = 2)
```

############################################
############################################
#############################################


#Assumption checking

```{r}
library(lattice)

Mod7 <- (gain ~1 + stud_pre_cent + retake + coll + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))
Mod8 <- (gain ~1 + stud_pre_cent + retake + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))

Mod10 <- (gain ~1 + stud_pre_cent + retake + coll*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))
Mod11 <- (gain ~1 + stud_pre_cent + pre_mean_class + retake + coll*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))

	for (i in 1:10) {
  D1 <- lmer(Mod11,data=MIdata[[i]])
  print(plot(D1, xlab="Fitted Value", ylab="Residual Variance"))
}

for (i in 1:10) {
  D1 <- lmer(Mod11,data=MIdata[[i]])
#visual homogeneity of variance
MIdata[[i]]$Model.F.Res <- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[i]]$Abs.Model.F.Res <-abs(MIdata[[1]]$Model.F.Res) #creates a new column with the absolute value of the residuals
print(boxplot(MIdata[[i]]$Model.F.Res ~ MIdata[[i]]$course_id, xlab = "Course", ylab = "Residuals" ))
}

for (i in 1:10) {
  D1 <- lmer(Mod11,data=MIdata[[i]])
#Assumption of Normality or residuals: want points to be near the line
print(qqmath(D1))
}
```
 # This produces a table of the pvalues for the correlations between the student level variables for pretest and the residuals. These p values should be large to indicate that there isn't a correlation
```{r}
res_corr <- data_frame(it =NA,
                       with_pre_score = NA,
                       with_cent_pre = NA)
 for (i in 1:10) {
res_corr[i,1] <- i
D1 <- lmer(Mod7,data=MIdata[[i]])
temp <- cor.test(resid(D1), MIdata[[i]]$pre_score)
res_corr[i,2] <-  temp$p.value 
temp <-  cor.test(resid(D1), MIdata[[i]]$stud_pre_cent)
res_corr[i,3] <- temp$p.value
}
```	
