---
title: "Equity analysis"
output: html_document
---

Load stuff (There are some packages that we don't need here, but I didn't clean them up. Sorry.)
```{r message=FALSE, warning=FALSE}
#load("~/hmi_data_1_10_19")
#load("~/Physics_Equity/hmifall2018_m10_better")
#load("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity_new/hmifall2018_m10_better")
load("~/hmi_1_23_19")
library("cAIC4")
library("MuMIn")
library(tidyr)
library("ggplot2")
library(gvlma)
library("HLMdiag")
library("DHARMa")
library("car") #for the Levene test which we will not discuss here
library("Matrix")
library(mitools)
library(stargazer)
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug
library(kableExtra)
plot_col <- c('#66c2a5', '#fc8d62', '#8da0cb')
#cbbpalette <- c('#000000','#E69F00','#56B4E9')
cbbpalette <- c( "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", 
    "#CC79A7","#000000", "#F0E442") #colorblind and grayscale friendly.
```

Creating mitml and extra variables
```{r}
#df_full <- complete(hmi.fall.2018)
#str(df_full)
MIdata<-mids2mitml.list(hmi_1_23_19) #converts file type
thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  temp <- left_join(temp,class_means,global_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$race_other_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)
  
```

dredge
```{r}
options(na.action = "na.fail")
#gain8 <- with(MIdata,(lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))))
dredge <- with(MIdata,{dredge(lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id)))})
#intro_mod_dredge <- glmer(m_all, data=red_introPhys,family = binomial)
#intro_dredge <- dredge(intro_mod_dredge)
model.sel(dredge[[1]], rank=AIC)
#best model is (gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))
```

Stat significance model selection
```{r}
gain_full <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))})
```

running models for model selection writing
```{r}
gain_ve <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture + (1|course_id))})
gain_ss <- with(MIdata,{lmer(gain ~1 +  (1|course_id))})
gain_ic <- with(MIdata,{lmer(gain ~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*lecture +  (1|course_id))})

testEstimates(gain_ve, var.comp=TRUE)
testEstimates(gain_ss, var.comp=TRUE)
testEstimates(gain_ic, var.comp=TRUE)
```

The next two blocks make the figures for the estimates for model 9
```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```

gain 8
```{r}
#     c(I,0,0, F,A,B, H,O,P, ,a,b, h,o,p)
WML = c(1,0,0, 0,0,0, 0,0,0, 0,0, 0,0,0)
WFL = c(1,0,0, 1,0,0, 0,0,0, 0,0, 0,0,0)

AML = c(1,0,0, 0,1,0, 0,0,0, 0,0, 0,0,0)
AFL = c(1,0,0, 1,1,0, 0,0,0, 1,0, 0,0,0)

BML = c(1,0,0, 0,0,1, 0,0,0, 0,0, 0,0,0)
BFL = c(1,0,0, 1,0,1, 0,0,0, 0,1, 0,0,0)

HML = c(1,0,0, 0,0,0, 1,0,0, 0,0, 0,0,0)
HFL = c(1,0,0, 1,0,0, 1,0,0, 0,0, 1,0,0)

OML = c(1,0,0, 0,0,0, 0,1,0, 0,0, 0,0,0)
OFL = c(1,0,0, 1,0,0, 0,1,0, 0,0, 0,1,0)

PML = c(1,0,0, 0,0,0, 0,0,1, 0,0, 0,0,0)
PFL = c(1,0,0, 1,0,0, 0,0,1, 0,0, 0,0,1)


contrast_forms_mod8 <- rbind('White Male'=WML,  
                          'White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_g8_est <- pool_and_cov_diffwm(gain8,contrast_forms_mod8)
unique(contrast_g8_est$race)

contrast_g8_est$race <- factor(contrast_g8_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))

ggplot(data=contrast_g8_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
ggplot(data=contrast_g8_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 
ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/mod8.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g8_est[c(1,2,6,7)], digits = 2)
```


gain 9
```{r}
#     c(I,0,0, F,A,B, H,O,P, L,a,b, h,o,p)
WML = c(1,0,0, 0,0,0, 0,0,0, 1,0,0, 0,0,0)
WMC = c(1,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0)
WFL = c(1,0,0, 1,0,0, 0,0,0, 1,0,0, 0,0,0)
WFC = c(1,0,0, 1,0,0, 0,0,0, 0,0,0, 0,0,0)

AML = c(1,0,0, 0,1,0, 0,0,0, 1,0,0, 0,0,0)
AMC = c(1,0,0, 0,1,0, 0,0,0, 0,0,0, 0,0,0)
AFL = c(1,0,0, 1,1,0, 0,0,0, 1,1,0, 0,0,0)
AFC = c(1,0,0, 1,1,0, 0,0,0, 0,1,0, 0,0,0)

BML = c(1,0,0, 0,0,1, 0,0,0, 1,0,0, 0,0,0)
BMC = c(1,0,0, 0,0,1, 0,0,0, 0,0,0, 0,0,0)
BFL = c(1,0,0, 1,0,1, 0,0,0, 1,0,1, 0,0,0)
BFC = c(1,0,0, 1,0,1, 0,0,0, 0,0,1, 0,0,0)

HML = c(1,0,0, 0,0,0, 1,0,0, 1,0,0, 0,0,0)
HMC = c(1,0,0, 0,0,0, 1,0,0, 0,0,0, 0,0,0)
HFL = c(1,0,0, 1,0,0, 1,0,0, 1,0,0, 1,0,0)
HFC = c(1,0,0, 1,0,0, 1,0,0, 0,0,0, 1,0,0)

OML = c(1,0,0, 0,0,0, 0,1,0, 1,0,0, 0,0,0)
OMC = c(1,0,0, 0,0,0, 0,1,0, 0,0,0, 0,0,0)
OFL = c(1,0,0, 1,0,0, 0,1,0, 1,0,0, 0,1,0)
OFC = c(1,0,0, 1,0,0, 0,1,0, 0,0,0, 0,1,0)

PML = c(1,0,0, 0,0,0, 0,0,1, 1,0,0, 0,0,0)
PMC = c(1,0,0, 0,0,0, 0,0,1, 0,0,0, 0,0,0)
PFL = c(1,0,0, 1,0,0, 0,0,1, 1,0,0, 0,0,1)
PFC = c(1,0,0, 1,0,0, 0,0,1, 0,0,0, 0,0,1)


contrast_forms_mod9 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC,
                          'Other Male Lecture'=OML, 'Other Male Collab'=OMC, 
                          'Other Female Lecture'=OFL,'Other Female Collab'=OFC,
                          'Island Male Lecture'=PML, 'Island Male Collab'=PMC, 
                          'Island Female Lecture'=PFL,'Island Female Collab'=PFC)

contrast_g9_est <- pool_and_cov_diffwm(gain9,contrast_forms_mod9)
contrast_g9_est$instruction <- factor(contrast_g9_est$instruction, levels = c("Lecture","Collab"))
ggplot(data=contrast_g9_est, aes(x=race_gender, y=Q, fill=instruction)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Lecture-based","Collaborative"),
                     values=plot_col) 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
#ggplot(data=contrast_g9_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+  facet_grid(.~instruction, scales = "free", space = "free")+  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +  ylab("Gain (Percentage Points)") +  scale_fill_manual(name="Gender",                     breaks= c("Female","Male"), values=cbbpalette) 
#ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/instruction.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g9_est[c(1,2,6,7)], digits = 2)
```

gain 10
```{r}
#     c(I,0,0, A,B,H, O,P,g, l,g*l)
WML = c(1,0,0, 0,0,0, 0,0,0, 1,0)
WMC = c(1,0,0, 0,0,0, 0,0,0, 0,0)
WFL = c(1,0,0, 0,0,0, 0,0,1, 1,1)
WFC = c(1,0,0, 0,0,0, 0,0,1, 0,0)

AML = c(1,0,0, 1,0,0, 0,0,0, 1,0)
AMC = c(1,0,0, 1,0,0, 0,0,0, 0,0)
AFL = c(1,0,0, 1,0,0, 0,0,1, 1,1)
AFC = c(1,0,0, 1,0,0, 0,0,1, 0,0)

BML = c(1,0,0, 0,1,0, 0,0,0, 1,0)
BMC = c(1,0,0, 0,1,0, 0,0,0, 0,0)
BFL = c(1,0,0, 0,1,0, 0,0,1, 1,1)
BFC = c(1,0,0, 0,1,0, 0,0,1, 0,0)

HML = c(1,0,0, 0,0,1, 0,0,0, 1,0)
HMC = c(1,0,0, 0,0,1, 0,0,0, 0,0)
HFL = c(1,0,0, 0,0,1, 0,0,1, 1,1)
HFC = c(1,0,0, 0,0,1, 0,0,1, 0,0)

OML = c(1,0,0, 0,0,0, 1,0,0, 1,0)
OMC = c(1,0,0, 0,0,0, 1,0,0, 0,0)
OFL = c(1,0,0, 0,0,0, 1,0,1, 1,1)
OFC = c(1,0,0, 0,0,0, 1,0,1, 0,0)

PML = c(1,0,0, 0,0,0, 0,1,0, 1,0)
PMC = c(1,0,0, 0,0,0, 0,1,0, 0,0)
PFL = c(1,0,0, 0,0,0, 0,1,1, 1,1)
PFC = c(1,0,0, 0,0,0, 0,1,1, 0,0)



contrast_forms_mod10 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC,
                          'Other Male Lecture'=OML, 'Other Male Collab'=OMC, 
                          'Other Female Lecture'=OFL,'Other Female Collab'=OFC,
                          'Island Male Lecture'=PML, 'Island Male Collab'=PMC, 
                          'Island Female Lecture'=PFL,'Island Female Collab'=PFC)

contrast_g10_est <- pool_and_cov_diffwm(gain10,contrast_forms_mod10)
contrast_g10_est$instruction <- factor(contrast_g9_est$instruction, levels = c("Lecture","Collab"))
ggplot(data=contrast_g10_est, aes(x=race_gender, y=Q, fill=instruction)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Lecture-based","Collaborative"),
                     values=plot_col) 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
ggplot(data=contrast_g10_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  facet_grid(.~instruction, scales = "free", space = "free")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 
#ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/instruction.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g10_est[c(1,2,6,7)], digits = 2)
```



model 11

```{r} 
#(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + retake + (1 + lecture |course_id))
#                              [Lecture Lecture   ]race x gender| lec X gend X race
#     c(I,L,A, B,H,O, P,F,0, 0, a,b, h,o,p,      f, A,B, H,O,P,  a,b,h, o,p)
WML = c(1,1,0, 0,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
WMC = c(1,0,0, 0,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
WFL = c(1,1,0, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,0,0,  0,0,0, 0,0)
WFC = c(1,0,0, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)

AML = c(1,1,1, 0,0,0, 0,0,0, 0, 1,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
AMC = c(1,0,1, 0,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
AFL = c(1,1,1, 0,0,0, 0,1,0, 0, 1,0, 0,0,0,      1, 1,0, 0,0,0,  1,0,0, 0,0)
AFC = c(1,0,1, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      0, 1,0, 0,0,0,  0,0,0, 0,0)

BML = c(1,1,0, 1,0,0, 0,0,0, 0, 0,1, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
BMC = c(1,0,0, 1,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
BFL = c(1,1,0, 1,0,0, 0,1,0, 0, 0,1, 0,0,0,      1, 0,1, 0,0,0,  0,1,0, 0,0)
BFC = c(1,0,0, 1,0,0, 0,1,0, 0, 0,0, 0,0,0,      0, 0,1, 0,0,0,  0,0,0, 0,0)

HML = c(1,1,0, 0,1,0, 0,0,0, 0, 0,0, 1,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
HMC = c(1,0,0, 0,1,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
HFL = c(1,1,0, 0,1,0, 0,1,0, 0, 0,0, 1,0,0,      1, 0,0, 1,0,0,  0,0,1, 0,0)
HFC = c(1,0,0, 0,1,0, 0,1,0, 0, 0,0, 0,0,0,      0, 0,0, 1,0,0,  0,0,0, 0,0)

OML = c(1,1,0, 0,0,1, 0,0,0, 0, 0,0, 0,1,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
OMC = c(1,0,0, 0,0,1, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
OFL = c(1,1,0, 0,0,1, 0,1,0, 0, 0,0, 0,1,0,      1, 0,0, 0,1,0,  0,0,0, 1,0)
OFC = c(1,0,0, 0,0,1, 0,1,0, 0, 0,0, 0,0,0,      0, 0,0, 0,1,0,  0,0,0, 0,0)

PML = c(1,1,0, 0,0,0, 1,0,0, 0, 0,0, 0,0,1,      0, 0,0, 0,0,0,  0,0,0, 0,0)
PMC = c(1,0,0, 0,0,0, 1,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
PFL = c(1,1,0, 0,0,0, 1,1,0, 0, 0,0, 0,0,1,      1, 0,0, 0,0,1,  0,0,0, 0,1)
PFC = c(1,0,0, 0,0,0, 1,1,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,1,  0,0,0, 0,0)

contrast_forms_mod11 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC,
                          'Other Male Lecture'=OML, 'Other Male Collab'=OMC, 
                          'Other Female Lecture'=OFL,'Other Female Collab'=OFC,
                          'Island Male Lecture'=PML, 'Island Male Collab'=PMC, 
                          'Island Female Lecture'=PFL,'Island Female Collab'=PFC)

contrast_g11_est <- pool_and_cov_diffwm(gain11,contrast_forms_mod11)
contrast_g11_est$instruction <- factor(contrast_g11_est$instruction, levels = c("Lecture","Collab"))

ggplot(data=contrast_g11_est, aes(x=race_gender, y=Q, fill=instruction)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Lecture-based","Collaborative"),
                     values=plot_col) 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
ggplot(data=contrast_g11_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  facet_grid(.~instruction, scales = "free", space = "free")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 
#ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/instruction.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g9_est[c(1,2,6,7)], digits = 2)
#model11
```



These are the differences with white males in that learning environment for Mod 8 where lecture isn't included
```{r}
#     c(I,0,0, F,A,B, H,O,P, ,a,b, h,o,p)
WFL = c(0,0,0, 1,0,0, 0,0,0, 0,0, 0,0,0)

AML = c(0,0,0, 0,1,0, 0,0,0, 0,0, 0,0,0)
AFL = c(0,0,0, 1,1,0, 0,0,0, 1,0, 0,0,0)

BML = c(0,0,0, 0,0,1, 0,0,0, 0,0, 0,0,0)
BFL = c(0,0,0, 1,0,1, 0,0,0, 0,1, 0,0,0)

HML = c(0,0,0, 0,0,0, 1,0,0, 0,0, 0,0,0)
HFL = c(0,0,0, 1,0,0, 1,0,0, 0,0, 1,0,0)

OML = c(0,0,0, 0,0,0, 0,1,0, 0,0, 0,0,0)
OFL = c(0,0,0, 1,0,0, 0,1,0, 0,0, 0,1,0)

PML = c(0,0,0, 0,0,0, 0,0,1, 0,0, 0,0,0)
PFL = c(0,0,0, 1,0,0, 0,0,1, 0,0, 0,0,1)


difference_forms_mod8 <- rbind('White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

```

```{r}
contrast_g8_est <- pool_and_cov_diffwm(gain8,difference_forms_mod8)

contrast_g8_est$instruction <- factor(contrast_g8_est$instruction, levels = c("Lecture","Collab"))

unique(contrast_g8_est$race_gender)

contrast_g8_est$group <- factor(contrast_g8_est$group, levels = c("White Female", "Asian Male", "Asian Female", "Hispanic Male", "Other Male", "Other Female", "Island Female", "Island Male",     "Black Female", "Hispanic Female", "Black Male"))

ggplot(data=contrast_g8_est, aes(x=group, y=Q, fill=gender)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  scale_fill_manual(name="Gender",
                     values=cbbpalette) +
  theme(legend.position = "bottom", axis.title.y=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(limits = c(-11,2), breaks = c(2,0,-2,-4,-6,-8,-10)) +
  coord_flip() 
  
ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/compare to WM.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")

  
 

kable(contrast_g8_est[c(1,2,6,7)], digits = 2)
```

```{r}

#     c(I,0,0, F,A,B, H,O,P, L,a,b, h,o,p)
WFL = c(0,0,0, 1,0,0, 0,0,0, 0,0,0, 0,0,0)
AML = c(0,0,0, 0,1,0, 0,0,0, 0,0,0, 0,0,0)
AFL = c(0,0,0, 1,1,0, 0,0,0, 0,1,0, 0,0,0)

BML = c(0,0,0, 0,0,1, 0,0,0, 0,0,0, 0,0,0)
BFL = c(0,0,0, 1,0,1, 0,0,0, 0,0,1, 0,0,0)

HML = c(0,0,0, 0,0,0, 1,0,0, 0,0,0, 0,0,0)
HFL = c(0,0,0, 1,0,0, 1,0,0, 0,0,0, 1,0,0)

OML = c(0,0,0, 0,0,0, 0,1,0, 0,0,0, 0,0,0)
OFL = c(0,0,0, 1,0,0, 0,1,0, 0,0,0, 0,1,0)

PML = c(0,0,0, 0,0,0, 0,0,1, 0,0,0, 0,0,0)
PFL = c(0,0,0, 1,0,0, 0,0,1, 0,0,0, 0,0,1)



difference_forms_mod9 <- rbind('White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_g9_est <- pool_and_cov_diffwm(gain9,difference_forms_mod9)

contrast_g9_est$instruction <- factor(contrast_g9_est$instruction, levels = c("Lecture","Collab"))


ggplot(data=contrast_g9_est, aes(x=group, y=Q)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  theme(legend.position = "bottom", axis.title.y=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain Relative to White Males (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col)+
  coord_flip()



  
  

kable(contrast_g8_est[c(1,2,6,7)], digits = 2)
```

```{r}
#(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + retake + (1 + lecture |course_id))
#                              [Lecture Lecture   ]race x gender| lec X gend X race
#     c(I,L,A, B,H,O, P,F,0, 0, a,b, h,o,p,      f, A,B, H,O,P,  a,b,h, o,p)
WFL = c(0,0,0, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,0,0,  0,0,0, 0,0)
AML = c(0,0,1, 0,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
AFL = c(0,0,1, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 1,0, 0,0,0,  0,0,0, 0,0)
BML = c(0,0,0, 1,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
BFL = c(0,0,0, 1,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,1, 0,0,0,  0,0,0, 0,0)
HML = c(0,0,0, 0,1,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
HFL = c(0,0,0, 0,1,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 1,0,0,  0,0,0, 0,0)
OML = c(0,0,0, 0,0,1, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
OFL = c(0,0,0, 0,0,1, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,1,0,  0,0,0, 0,0)
PML = c(0,0,0, 0,0,0, 1,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
PFL = c(0,0,0, 0,0,0, 1,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,0,1,  0,0,0, 0,0)


difference_forms_mod11.1 <- rbind('White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_g11.1_est <- pool_and_cov_diffwm(gain11,difference_forms_mod11.1)

contrast_g11.1_est$instruction <- factor(contrast_g11.1_est$instruction, levels = c("Lecture","Collab"))


ggplot(data=contrast_g11.1_est, aes(x=group, y=Q)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  theme(legend.position = "bottom", axis.title.y=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col) +
  coord_flip()



  
  

kable(contrast_g11.1_est[c(1,2,6,7)], digits = 2)
```

```{r}
#(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + retake + (1 + lecture |course_id))
#                              [Lecture Lecture   ]race x gender| lec X gend X race
#     c(I,L,A, B,H,O, P,F,0, 0, a,b, h,o,p,      f, A,B, H,O,P,  a,b,h, o,p)
WFL = c(0,0,0, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,0,0,  0,0,0, 0,0)
AML = c(0,0,1, 0,0,0, 0,0,0, 0, 1,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
AFL = c(0,0,1, 0,0,0, 0,1,0, 0, 1,0, 0,0,0,      1, 1,0, 0,0,0,  1,0,0, 0,0)
BML = c(0,0,0, 1,0,0, 0,0,0, 0, 0,1, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
BFL = c(0,0,0, 1,0,0, 0,1,0, 0, 0,1, 0,0,0,      1, 0,1, 0,0,0,  0,1,0, 0,0)
HML = c(0,0,0, 0,1,0, 0,0,0, 0, 0,0, 1,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
HFL = c(0,0,0, 0,1,0, 0,1,0, 0, 0,0, 1,0,0,      1, 0,0, 1,0,0,  0,0,1, 0,0)
OML = c(0,0,0, 0,0,1, 0,0,0, 0, 0,0, 0,1,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
OFL = c(0,0,0, 0,0,1, 0,1,0, 0, 0,0, 0,1,0,      1, 0,0, 0,1,0,  0,0,0, 1,0)
PML = c(0,0,0, 0,0,0, 1,0,0, 0, 0,0, 0,0,1,      0, 0,0, 0,0,0,  0,0,0, 0,0)
PFL = c(0,0,0, 0,0,0, 1,1,0, 0, 0,0, 0,0,1,      1, 0,0, 0,0,1,  0,0,0, 0,1)


difference_forms_mod11.2 <- rbind('White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_g11.2_est <- pool_and_cov_diffwm(gain11,difference_forms_mod11.2)

contrast_g11.2_est$instruction <- factor(contrast_g11.2_est$instruction, levels = c("Lecture","Collab"))


ggplot(data=contrast_g11.2_est, aes(x=group, y=Q)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  theme(legend.position = "bottom", axis.title.y=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col) +
  coord_flip()



  
  

kable(contrast_g11.1_est[c(1,2,6,7)], digits = 2)
```
