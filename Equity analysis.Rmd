---
title: "Equity analysis"
output: html_document
---

Load stuff (There are some packages that we don't need here, but I didn't clean them up. Sorry.)
```{r message=FALSE, warning=FALSE}
load("~/Physics_Equity/hmifall2018_m10_better")

library(tidyr)
library("ggplot2")
library(gvlma)
library("HLMdiag")
library("DHARMa")
library("car") #for the Levene test which we will not discuss here
library("Matrix")
library(mitools)
library(stargazer)
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug

```

This function pools the results across the MI for each of the groups and calculates their covariance with white males
x=model, y= formula matrix
```{r}
pool_and_cov <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T),
                            cvwm = mean(cov.White.Male.Lecture)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```

Creating mitml and extra variables
```{r}
#df_full <- complete(hmi.fall.2018)
#str(df_full)
MIdata<-mids2mitml.list(hmi.fall.2018) #converts file type

thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  class_means$class_pre_cent <- class_means$pre_mean_class - mean(class_means$pre_mean_class)
  temp <- left_join(temp,class_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- temp$colab_no_la + temp$used_las
  #assign(df.names[i], temp)
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)

```

Ben's Models
```{r }
gain1 <- with(MIdata,{lmer(gain~1 + (1|course_id))})
#gain2 <- with(MIdata,{lmer(gain~1 + gend_URM + (1|course_id))})
gain2 <- with(MIdata,{lmer(gain~1 + race_URM + gend_URM + (1|course_id))})
gain3 <- with(MIdata,{lmer(gain~1 + race_URM*gend_URM + (1|course_id))})
gain4 <- with(MIdata,{lmer(gain~1 + race_URM + gend_URM + stud_pre_cent + (1|course_id))})
gain5 <- with(MIdata,{lmer(gain~1 + race_URM + gend_URM + stud_pre_cent + coll + (1|course_id))})
gain6 <- with(MIdata,{lmer(gain~1 +race_URM*coll + gend_URM*coll+ stud_pre_cent + (1|course_id))})
```

```{r eval=FALSE, include=FALSE}
testEstimates(gain1, var.comp=TRUE)
testEstimates(gain2, var.comp=TRUE)
testEstimates(gain3, var.comp=TRUE)
testEstimates(gain4, var.comp=TRUE)
testEstimates(gain5, var.comp=TRUE) #best model
testEstimates(gain6, var.comp=TRUE)
```

This produces the estimates for gain5
```{r}
WML = c(1,0,0,0,0)
WMC = c(1,0,0,0,1)
BML = c(1,1,0,0,0)
BMC = c(1,1,0,0,1)
WFL = c(1,0,1,0,0)
WFC = c(1,0,1,0,1)
BFL = c(1,1,1,0,0)
BFC = c(1,1,1,0,1)

contrast_forms_mod5 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC)
```

These are the differences with same group in lecture
```{r}
WM = c(0,0,0,0, 1)
BM = c(0,0,0,0, 1)
WF = c(0,0,0,0, 1)
BF = c(0,0,0,0, 1)

difference_forms_self_5 <- rbind('White Male' = WM,
                          'Black Male'=BM, 
                          'White Female'=WF, 
                          'Black Female'=BF)
```

These are the differences with white males in that learning environment
```{r}
BML = c(0,1,0,0, 0)
WFL = c(0,0,1,0, 0)
BFL = c(0,1,1,0, 0)
BMC = c(0,1,0,0, 0)
WFC = c(0,0,1,0, 0)
BFC = c(0,1,1,0, 0)

difference_forms_wm_5 <- rbind( 
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC)
```

```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")

return <- p3est}
```

```{r}
diff_self_g5_est <- pool_and_cov_diffwm(gain5,difference_forms_self_5)
ggplot(data=diff_self_g5_est, aes(x=group, y=Q)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE))#+
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```

```{r}
diff_wm_g5_est <- pool_and_cov_diffwm(gain5,difference_forms_wm_5)
ggplot(data=diff_wm_g5_est, aes(x=group, y=Q, fill=instruction)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```
```{r}
contrast_g5_est <- pool_and_cov_diffwm(gain5,contrast_forms_mod5)
ggplot(data=contrast_g5_est, aes(x=group, y=Q, fill=instruction)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE))+
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```
```{r}
temp <- contrast_g5_est[c(2,11,12)]
temp2 <- temp[temp$instruction=="Collab",]
temp3 <- temp[temp$instruction=="Lecture",]
temp4 <- left_join(temp2,temp3, by="race_gender")

temp4$ratio_self <- temp4$Q.x/temp4$Q.y

ggplot(data=temp4, aes(x=race_gender, y=ratio_self)) +geom_bar(stat = "identity")  

```

```{r}
temp <- contrast_g5_est[c(1,2,11,12)] 
temp$ratio_wml <- temp$Q/15.32
ggplot(data=temp, aes(x=group, y=ratio_wml, fill=instruction)) +geom_bar(stat = "identity") + 
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```


```{r}
temp <- contrast_g5_est[c(1,2,11,12)]
temp2 <- temp[temp$instruction=="Collab",]
temp2$ratio_wm_same <- temp2$Q/21.993
temp3 <- temp[temp$instruction=="Lecture",]
temp3$ratio_wm_same <- temp3$Q/15.931
temp4 <- bind_rows(temp2,temp3)

ggplot(data=temp4, aes(x=group, y=ratio_wm_same, fill=instruction)) +geom_bar(stat = "identity") + 
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```


I want to run it to make the ratios with error bars against self in lecture
```{r}
WML = c(1,0,0,0, 0,0,0,0)
WMC = c(1,0,1,0, 0,0,0,0)

contrast_self_mod4 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC)

diff_wm_g4_est <- pool_and_cov_diffwm(gain4,difference_forms_wm_4)


sxp3 <- summary(glht(gain4[[1]], linfct=contrast_self_mod4)) #specifically for post3
  covp3 <- vcov(glht(gain4[[1]], linfct=contrast_self_mod4))
thing <-data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
```

Run 10 HLM 3 models
```{r}
D1 <- lmer(gain~1 + race_URM + gend_URM + stud_pre_cent + coll + (1|course_id),data=MIdata[[1]])
```

Assumption checking code to be done for all 10 datasets
```{r}
#linearity: Shouldn't see a pattern
plot(D1)

#variables are not correlated to the residuals: want a p-value>0.05
cor.test(resid(D1), MIdata[[1]]$pre_scor) 
cor.test(resid(D1), MIdata[[1]]$stud_pre_cent)

#quantitative homogeneity of variance
MIdata[[1]]$Model.F.Res<- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[1]]$Abs.Model.F.Res <-abs(MIdata[[1]]$Model.F.Res) #creates a new column with the absolute value of the residuals
#MIdata[[1]]$Model.F.Res2 <- MIdata[[1]]$Abs.Model.F.Res^2 #squares the absolute values of the residuals to provide the more robust estimate

Levene.Model.F <- lm(Model.F.Res ~ course_id, data=MIdata[[1]]) #ANOVA of the residuals
anova(Levene.Model.F) #displays the results: want a p>0.05

#Levene.Model.F2 <- lm(Model.F.Res2 ~ crse_id, data=MIdata[[1]]) #ANOVA of the squared residuals
#anova(Levene.Model.F2) #displays the results

#visual homogeneity of variance
boxplot(MIdata[[1]]$Model.F.Res ~ MIdata[[1]]$course_id)
#boxplot(MIdata[[1]]$Model.F.Res2 ~ MIdata[[1]]$crse_id)

#Assumption of Normality or residuals: want points to be near the line
qqmath(D1)
```


Old stuff below here


Jayson's Models
```{r eval=FALSE, include=TRUE}
gain1 <- with(MIdata,{lmer(gain~1 + (1|course_id))})
gain2 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + class_pre_cent + (1|course_id))})
gain3 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + class_pre_cent + race_URM + gend_URM + (1|course_id))})
gain4 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + class_pre_cent + race_URM*gend_URM + (1|course_id))})
gain5 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + class_pre_cent + race_URM + gend_URM + coll+ (1|course_id))})
gain5.5 <- with(MIdata,{lmer(gain~1 + race_URM + gend_URM + coll+ (1|course_id))})
gain6 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + class_pre_cent + race_URM*coll + gend_URM*coll + (1|course_id))})

testEstimates(gain1, var.comp=TRUE)
testEstimates(gain2, var.comp=TRUE)
testEstimates(gain3, var.comp=TRUE)
testEstimates(gain4, var.comp=TRUE)
testEstimates(gain5, var.comp=TRUE)
testEstimates(gain5.5, var.comp=TRUE)

testEstimates(gain6, var.comp=TRUE)
```

recode this to look at the differences between the groups that we are interested in.
```{r}
gain4 <- with(MIdata,{lmer(gain~1 +race_URM*collaborative + gend_URM*collaborative + pre_score + class_pre_cent + (1|course_id))})

WML = c(1,0,0,0, 0,0,0,0, 0)
WMC = c(1,0,1,0, 0,0,0,0, 0)
BML = c(1,0,0,0, 1,0,0,0, 0)
BMC = c(1,0,1,0, 1,0,0,1, 0)
WFL = c(1,0,0,0, 0,1,0,0, 0)
WFC = c(1,0,1,0, 0,1,0,0, 1)
BFL = c(1,0,0,0, 1,1,0,0, 0)
BFC = c(1,0,1,0, 1,1,0,1, 1)

contrast_forms_mod4 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC)
```

Differences between traditionally underrepresented groups and white males in the same learning context
```{r}
BML = c(0,0,0,0, -1,0,0,0, 0)
WFL = c(0,0,0,0, 0,-1,0,0, 0)
BFL = c(0,0,0,0, -1,-1,0,0, 0)
BMC = c(0,0,0,0, -1,0,0,-1, 0)
WFC = c(0,0,0,0, 0,-1,0,0, -1)
BFC = c(0,0,0,0, -1,-1,0,1, -1)

difference_forms_wm <- rbind( 
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC)
```

Similar formula but this one doesn't include the covariances with white males.
```{r}

sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))


pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 

return <- p3est}
```

```{r}
diff_wm_g4_est <- pool_and_cov_diffwm(gain4,difference_forms_wm)
diff_wm_p4_est <- pool_and_cov_diffwm(post4,difference_forms_wm)

get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(gain4[[i]], linfct=difference_forms_wm)) #specifically for post3

  
  covp3 <- vcov(glht(gain4[[i]], linfct=difference_forms_wm))
  
  
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 

```



Creating groups for final model
```{r}
WM=c(1,0,0,0,0,0,0,0,0,0,0,0,0)
WMC=c(1,0,1,0,0,0,0,0,0,0,0,0,0)
WMLA=c(1,0,0,1,0,0,0,0,0,0,0,0,0)
BM=c(1,0,0,0,0,1,0,0,0,0,0,0,0)
BMC=c(1,0,1,0,0,1,0,0,0,0,1,0,0)
BMLA=c(1,0,0,1,0,1,0,0,0,1,0,0,0)
WF=c(1,0,0,0,0,0,1,0,0,0,0,0,0)
WFC=c(1,0,1,0,0,0,1,0,0,0,0,0,1)
WFLA=c(1,0,0,1,0,0,1,0,0,0,0,1,0)
BF=c(1,0,0,0,0,1,1,0,0,0,0,0,0)
BFC=c(1,0,1,0,0,1,1,0,0,0,1,0,1)
BFLA=c(1,0,0,1,0,1,1,0,0,1,0,1,0)

contrast.formulas <-rbind('White Male Lecture'=WM, 'White Male Collab'=WMC, 'White Male LA'=WMLA,
                          'Black Male Lecture'=BM, 'Black Male Collab'=BMC, 'Black Male LA'=BMLA,
                          'White Female Lecture'=WF,'White Female Collab'=WFC, 'White Female LA'=WFLA,
                          'Black Female Lecture'=BF,'Black Female Collab'=BFC, 'Black Female LA'=BFLA)
```

Confidence interval for MI attempt (This is where I'm stuck)
modpost3<-(pst_scor~1 + stud_pre_cent*collabnla+ stud_pre_cent*used_las+ class_pre_cent + race_urm*used_las+ race_urm*collabnla + gen_urm*used_las + gen_urm*collabnla+ (1|crse_id))



```{r}
g3est <- pool_and_cov(gain4,contrast_forms_mod4)
p3est <- pool_and_cov(post4,contrast_forms_mod4)

```


```{r}
ggplot(data=p3est, aes(x=group, y=Q, fill=race_gender)) +geom_bar(stat = "identity", position = ) + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE))+
  facet_grid(.~instruction)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 

ggplot(data=p3est, aes(x=group, y=Q, fill=instruction)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE))+
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 


ggplot(data=g3est, aes(x=group, y=Q, fill=instruction)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE))+
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 

```




Gain Ratios against majority
```{r}
maj_numbers <- c(10,11,12,10,11,12,10,11,12)
gain_against_maj <- foreach(i=1:9, .combine=rbind) %do% {
                   data.frame(ratio = g3est$Q[i]/g3est$Q[maj_numbers[i]],
                              se = sqrt( (g3est$Q[i]/g3est$Q[maj_numbers[i]])^2*(g3est$T[i]/g3est$Q[i]^2+g3est$T[maj_numbers[i]]/g3est$Q[maj_numbers[i]]^2-2*(g3est$cvwm[i]/(g3est$Q[i]*g3est$Q[maj_numbers[i]])))) )
}

temp1 <- data.frame (group = c("BF","BFC","BFL","BM","BMC","BML","WF","WFC","WFL"),
                              race = c("URM","URM","URM","URM","URM","URM","Maj","Maj","Maj"),
                              gender = c("URM","URM","URM","Maj","Maj","Maj","URM","URM","URM"),
                              instruction = c("Lecture","Collaborative","LA","Lecture","Collaborative","LA","Lecture","Collaborative","LA"),
                              race_gender = c("Black Female","Black Female","Black Female","Black Male","Black Male","Black Male","White Female","White Female","White Female")
)    

gain_against_maj <- bind_cols(temp1,gain_against_maj)
```

```{r}
ggplot(data=gain_against_maj, aes(x=group, y=ratio, fill=instruction)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= ratio+2*se, ymin=ratio-2*se))+
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```




Ratios against self
```{r}
ratsBFC = g3est$Q[2]/g3est$Q[1]
ratsBFL = g3est$Q[3]/g3est$Q[1]
ratsBMC = g3est$Q[5]/g3est$Q[4]
ratsBML = g3est$Q[6]/g3est$Q[4]
ratsWFC = g3est$Q[8]/g3est$Q[7]
ratsWFL = g3est$Q[9]/g3est$Q[7]
ratsWMC = g3est$Q[11]/g3est$Q[10]
ratsWML = g3est$Q[12]/g3est$Q[10]

s.e.ratsBF = sqrt((ratsBF)^2*((g3est$T[2])/(g3est$Q[2]^2)+(g3est$T[1])/(g3est$Q[1]^2)-2*(g3est$cvwm[1]/((g3est$Q[1])*(g3est$Q[10]))))) #This doesn't work becuse I have to update the cvwm factor. 

ratsBFC
ratsBFL 
ratsBMC
ratsBML
ratsWFC
ratsWFL
ratsWMC
ratsWML
```


```{r}
temp <- complete(hmi.fall.2018)

temp2 <- unique(temp[c(2,10:15)])

  colSums(temp2[c(-1)])
temp3 <- temp[temp$colab_no_la==1,]
  
```

