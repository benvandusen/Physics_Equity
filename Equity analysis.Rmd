---
title: "Equity analysis"
output: html_document
---

Load stuff (There are some packages that we don't need here, but I didn't clean them up. Sorry.)
```{r message=FALSE, warning=FALSE}
#load("~/hmi_data_1_10_19")
#load("~/Physics_Equity/hmifall2018_m10_better")
#load("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity_new/hmifall2018_m10_better")
load("~/hmi_1_23_19")
library(tidyr)
library("ggplot2")
library(gvlma)
library("HLMdiag")
library("DHARMa")
library("car") #for the Levene test which we will not discuss here
library("Matrix")
library(mitools)
library(stargazer)
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug
library(kableExtra)
plot_col <- c('#66c2a5', '#fc8d62', '#8da0cb')
#cbbpalette <- c('#000000','#E69F00','#56B4E9')
cbbpalette <- c( "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", 
    "#CC79A7","#000000", "#F0E442") #colorblind and grayscale friendly.
```

Creating mitml and extra variables
```{r}
#df_full <- complete(hmi.fall.2018)
#str(df_full)
MIdata<-mids2mitml.list(hmi_1_23_19) #converts file type
thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  class_means$class_pre_cent <- class_means$pre_mean_class - mean(class_means$pre_mean_class)
  temp <- left_join(temp,class_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$coll <- ifelse(temp$lecture %in% 1,0,1)
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$race_other_no_int[temp$amind_no_int %in% 1] <- 1 # combines the american indian students in to the other group there were 61 if these students
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)
  
```

#Descriptive statistics by lecture and gender
```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$pacisland_no_int ==1, "Island",ifelse(temp$race_other_no_int ==1, "Other","White")))))
desc <- temp %>% group_by(lecture, gend_URM) %>% summarise(N = length(pre_score),
                                                                 pre_mean = mean(pre_score),
                                                                 pre_sd = sd(pre_score),
                                                                 post_mean = mean(post_score),
                                                                 post_sd = sd(post_score),
                                                                 gain_mean = mean (post_score-pre_score),
                                                                 gain_sd = sd(post_score-pre_score)
                                                                 )


return <- desc
}
desc <- desc2 %>% group_by(lecture, gend_URM) %>% summarise_all(funs(mean))
desc$lecture <- ifelse(desc$lecture ==1, "Lecture","Collaborative")
desc$gend_URM <- ifelse(desc$gend_URM==1, "Female","Male")
kable(desc, digits=1)
```

#Descriptive statistics by lecture
```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$pacisland_no_int ==1, "Island",ifelse(temp$race_other_no_int ==1, "Other","White")))))
desc <- temp  %>% summarise(N = length(pre_score),
                                                                 pre_mean = mean(pre_score),
                                                                 pre_sd = sd(pre_score),
                                                                 post_mean = mean(post_score),
                                                                 post_sd = sd(post_score),
                                                                 gain_mean = mean (post_score-pre_score),
                                                                 gain_sd = sd(post_score-pre_score)
                                                                 )


return <- desc
}
desc <- desc2 %>% summarise_all(funs(mean))
#desc$lecture <- ifelse(desc$lecture ==1, "Lecture","Collaborative")
#desc$gend_URM <- ifelse(desc$gend_URM==1, "Female","Male")
kable(desc, digits=1)
```

#Descriptive statistics by lecture, race and gender
```{r}
#variables: M, group by

desc2 <- foreach(i=1:10, .combine=rbind) %do% {
temp <- MIdata[[i]]
temp$race <- ifelse(temp$black_no_int ==1, "Black",ifelse(temp$hispanic_no_int ==1, "Hispanic",ifelse(temp$asian_no_int ==1, "Asian",ifelse(temp$pacisland_no_int ==1, "Island",ifelse(temp$race_other_no_int ==1, "Other","White")))))
desc <- temp %>% group_by( lecture, race, gend_URM) %>% summarise(N = length(pre_score),
                                                                 pre_mean = mean(pre_score),
                                                                 pre_sd = sd(pre_score),
                                                                 post_mean = mean(post_score),
                                                                 post_sd = sd(post_score),
                                                                 gain_mean = mean (post_score-pre_score),
                                                                 gain_sd = sd(post_score-pre_score)
                                                                 )


return <- desc
}
desc <- desc2 %>% group_by(race, lecture, gend_URM) %>% summarise_all(funs(mean))
desc$lecture <- ifelse(desc$lecture ==1, "Lecture","Collaborative")
desc$gend_URM <- ifelse(desc$gend_URM==1, "Female","Male")
kable(desc, digits=1)
sum(temp$hispanic_no_int)
length(temp[temp$his])

```



```{r }
gain1 <- with(MIdata,{lmer(gain~1 + (1|course_id))})
gain2 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + (1|course_id))})
gain3 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + (1|course_id))})
gain4 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + pre_mean_class + (1|course_id))})
gain5 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + FMCE + (1|course_id))})
gain6 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + (1|course_id))})
#gain6.1 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + race_URM + (1|course_id))})
#gain7 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + lecture + gend_URM*race_URM + (1|course_id))})

gain8 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) +  (1|course_id))})
#gain8.1 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int |course_id))})
gain8.2 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1 + stud_pre_cent |course_id))})
gain8.3 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1 + stud_pre_cent + retake |course_id))})
gain8.4 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture + (1 + stud_pre_cent + gend_URM |course_id))})
#gain8.5 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1 + stud_pre_cent + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int |course_id))})
#gain8.1 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + race_URM + lecture +   (1|course_id))})
#gain8.3 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1|course_id) + (1|inst_id))})
#gain8.5 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1|course_id))})
gain9 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture + (1  + stud_pre_cent|course_id))})
#gain9.1 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*race_URM + lecture +   (1|course_id))})
#gain10 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int + gend_URM*lecture +  (1|course_id))})
#gain10.1 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*lecture + race_URM + (1|course_id))})
gain11 <- with(MIdata,{lmer(gain~1 + lecture*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int)*gend_URM + stud_pre_cent + retake + (1 + lecture |course_id))})
gain11.2 <- with(MIdata,{lmer(gain~1 + lecture*race_URM*gend_URM + stud_pre_cent + retake + (1|course_id))})
#gain11.1 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + race_URM*lecture + (1|course_id))})
gain12 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) |course_id))})

gain12.7 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture + (1 + stud_pre_cent + retake |course_id))})

#mod9 <- gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + lecture + (1|course_id)

pre1 <- with(MIdata,{lmer(pre_score~1 + (1|course_id))})
pre2 <- with(MIdata,{lmer(pre_score~1 + retake + (1|course_id))})
pre3 <- with(MIdata,{lmer(pre_score~1 + FMCE + (1|course_id))})
#pre3.1 <- with(MIdata,{lmer(pre_score~1 + FMCE + lecture + (1|course_id))})
pre4 <- with(MIdata,{lmer(pre_score~1 + FMCE + gend_URM + (1|course_id))})
pre5 <- with(MIdata,{lmer(pre_score~1 + FMCE + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})
pre5.1 <- with(MIdata,{lmer(pre_score~1 + FMCE + gend_URM + (asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})
pre6 <- with(MIdata,{lmer(pre_score~1 + FMCE*gend_URM + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})
pre7 <- with(MIdata,{lmer(pre_score~1 + FMCE*gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id))})
```

```{r echo=FALSE}
testEstimates(gain1, var.comp=TRUE)
#testEstimates(gain1.1, var.comp=TRUE)
testEstimates(gain2, var.comp=TRUE)
testEstimates(gain3, var.comp=TRUE)
testEstimates(gain4, var.comp=TRUE)
testEstimates(gain5, var.comp=TRUE) 
testEstimates(gain6, var.comp=TRUE)

#testEstimates(gain7, var.comp=TRUE)
testEstimates(gain8, var.comp=TRUE) #best model
#testEstimates(gain8.1, var.comp=TRUE)
testEstimates(gain8.2, var.comp=TRUE)
testEstimates(gain8.3, var.comp=TRUE)
testEstimates(gain8.4, var.comp=TRUE)
#testEstimates(gain8.5, var.comp=TRUE)
testEstimates(gain9, var.comp=TRUE)
testEstimates(gain12.2, var.comp=TRUE)
testEstimates(gain12.3, var.comp=TRUE)
testEstimates(gain12.4, var.comp=TRUE)
testEstimates(gain12.5, var.comp=TRUE)
testEstimates(gain12.6, var.comp=TRUE)
#testEstimates(gain10, var.comp=TRUE)
testEstimates(gain11, var.comp=TRUE)
#testEstimates(gain11.2, var.comp=TRUE)
testEstimates(gain12, var.comp=TRUE)

testEstimates(pre1, var.comp=TRUE)
testEstimates(pre2, var.comp=TRUE)
testEstimates(pre3, var.comp=TRUE)
#testEstimates(pre3.1, var.comp=TRUE)
testEstimates(pre4, var.comp=TRUE)
testEstimates(pre5, var.comp=TRUE)
testEstimates(pre5.1, var.comp=TRUE)
testEstimates(pre6, var.comp=TRUE)
testEstimates(pre7, var.comp=TRUE)
```

This makes a table for the model development. Two sections need to be modified. The models and the equation column.
```{r}
models <- c("gain1","gain2","gain3","gain4","gain5","gain6","gain7","gain8","gain9","gain10","gain11")
mod_var_tab <- data_frame(model = NA,
                          level2 = NA,
                          level1 = NA,
                          ICC = NA)
for(i in 1:11){
  temp <- testEstimates(get(models[i]), var.comp=TRUE)
  mod_var_tab[i,1] <- models[i]
  mod_var_tab[i,2] <- temp$var.comp[1]
  mod_var_tab[i,3] <- temp$var.comp[2]
  mod_var_tab[i,4] <- temp$var.comp[3]
  }
mod_var_tab$lvl1change <- (mod_var_tab$level1[1]- mod_var_tab$level1)/mod_var_tab$level1[1]
mod_var_tab$lvl2change <- (mod_var_tab$level2[1]- mod_var_tab$level2)/mod_var_tab$level2[1]
mod_var_tab$equation <- c("gain~1 + (1|course_id)","gain~1 + stud_pre_cent + (1|course_id))","gain~1 + stud_pre_cent + retake + (1|course_id)","gain~1 + stud_pre_cent + retake + FMCE + (1|course_id)","gain~1 + stud_pre_cent + retake + FMCE + (1|course_id)","gain~1 + stud_pre_cent + retake + gend_URM + (1|course_id)", "gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + (1|course_id)","gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1|course_id)","gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int) + lec + (1|course_id)","gain~1 + stud_pre_cent + retake + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + gend_URM*lec +  (1|course_id)","gain~1 + lec*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int) + gend_URM + stud_pre_cent + retake + (1|course_id)")
#"gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1 + stud_pre_cent + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int |course_id)"
```

The next three blocks make the figures for the estimates for model 9
```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```

Pre1
```{r}
mod_pre_1 <- pre_score~1 + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int  + pacisland_no_int) + (1|course_id)

#     c(I, F,A,B, H,O,P, a,b, h,o,p)
WML = c(1, 0,0,0, 0,0,0, 0,0, 0,0,0)
WFL = c(1, 1,0,0, 0,0,0, 0,0, 0,0,0)

AML = c(1, 0,1,0, 0,0,0, 0,0, 0,0,0)
AFL = c(1, 1,1,0, 0,0,0, 1,0, 0,0,0)

BML = c(1, 0,0,1, 0,0,0, 0,0, 0,0,0)
BFL = c(1, 1,0,1, 0,0,0, 0,1, 0,0,0)

HML = c(1, 0,0,0, 1,0,0, 0,0, 0,0,0)
HFL = c(1, 1,0,0, 1,0,0, 0,0, 1,0,0)

OML = c(1, 0,0,0, 0,1,0, 0,0, 0,0,0)
OFL = c(1, 1,0,0, 0,1,0, 0,0, 0,1,0)

PML = c(1, 0,0,0, 0,0,1, 0,0, 0,0,0)
PFL = c(1, 1,0,0, 0,0,1, 0,0, 0,0,1)


contrast_forms_mod_pre_1 <- rbind('White Male'=WML,  
                          'White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_p1_est <- pool_and_cov_diffwm(pre1,contrast_forms_mod_pre_1)
unique(contrast_p1_est$race)

contrast_p1_est$race <- factor(contrast_p1_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))

ggplot(data=contrast_p1_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
ggplot(data=contrast_p1_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 
ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/pre1.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g8_est[c(1,2,6,7)], digits = 2)
```


gain 8
```{r}
#     c(I,0,0, F,A,B, H,O,P, ,a,b, h,o,p)
WML = c(1,0,0, 0,0,0, 0,0,0, 0,0, 0,0,0)
WFL = c(1,0,0, 1,0,0, 0,0,0, 0,0, 0,0,0)

AML = c(1,0,0, 0,1,0, 0,0,0, 0,0, 0,0,0)
AFL = c(1,0,0, 1,1,0, 0,0,0, 1,0, 0,0,0)

BML = c(1,0,0, 0,0,1, 0,0,0, 0,0, 0,0,0)
BFL = c(1,0,0, 1,0,1, 0,0,0, 0,1, 0,0,0)

HML = c(1,0,0, 0,0,0, 1,0,0, 0,0, 0,0,0)
HFL = c(1,0,0, 1,0,0, 1,0,0, 0,0, 1,0,0)

OML = c(1,0,0, 0,0,0, 0,1,0, 0,0, 0,0,0)
OFL = c(1,0,0, 1,0,0, 0,1,0, 0,0, 0,1,0)

PML = c(1,0,0, 0,0,0, 0,0,1, 0,0, 0,0,0)
PFL = c(1,0,0, 1,0,0, 0,0,1, 0,0, 0,0,1)


contrast_forms_mod8 <- rbind('White Male'=WML,  
                          'White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_g8_est <- pool_and_cov_diffwm(gain8,contrast_forms_mod8)
unique(contrast_g8_est$race)

contrast_g8_est$race <- factor(contrast_g8_est$race, levels = c("Black", "Hispanic", "Island", "Other", "Asian",    "White"))

ggplot(data=contrast_g8_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
ggplot(data=contrast_g8_est, aes(x=race, y=Q, fill=gender)) + geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 
ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/mod8.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g8_est[c(1,2,6,7)], digits = 2)
```


gain 9
```{r}
#     c(I,0,0, F,A,B, H,O,P, L,a,b, h,o,p)
WML = c(1,0,0, 0,0,0, 0,0,0, 1,0,0, 0,0,0)
WMC = c(1,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0)
WFL = c(1,0,0, 1,0,0, 0,0,0, 1,0,0, 0,0,0)
WFC = c(1,0,0, 1,0,0, 0,0,0, 0,0,0, 0,0,0)

AML = c(1,0,0, 0,1,0, 0,0,0, 1,0,0, 0,0,0)
AMC = c(1,0,0, 0,1,0, 0,0,0, 0,0,0, 0,0,0)
AFL = c(1,0,0, 1,1,0, 0,0,0, 1,1,0, 0,0,0)
AFC = c(1,0,0, 1,1,0, 0,0,0, 0,1,0, 0,0,0)

BML = c(1,0,0, 0,0,1, 0,0,0, 1,0,0, 0,0,0)
BMC = c(1,0,0, 0,0,1, 0,0,0, 0,0,0, 0,0,0)
BFL = c(1,0,0, 1,0,1, 0,0,0, 1,0,1, 0,0,0)
BFC = c(1,0,0, 1,0,1, 0,0,0, 0,0,1, 0,0,0)

HML = c(1,0,0, 0,0,0, 1,0,0, 1,0,0, 0,0,0)
HMC = c(1,0,0, 0,0,0, 1,0,0, 0,0,0, 0,0,0)
HFL = c(1,0,0, 1,0,0, 1,0,0, 1,0,0, 1,0,0)
HFC = c(1,0,0, 1,0,0, 1,0,0, 0,0,0, 1,0,0)

OML = c(1,0,0, 0,0,0, 0,1,0, 1,0,0, 0,0,0)
OMC = c(1,0,0, 0,0,0, 0,1,0, 0,0,0, 0,0,0)
OFL = c(1,0,0, 1,0,0, 0,1,0, 1,0,0, 0,1,0)
OFC = c(1,0,0, 1,0,0, 0,1,0, 0,0,0, 0,1,0)

PML = c(1,0,0, 0,0,0, 0,0,1, 1,0,0, 0,0,0)
PMC = c(1,0,0, 0,0,0, 0,0,1, 0,0,0, 0,0,0)
PFL = c(1,0,0, 1,0,0, 0,0,1, 1,0,0, 0,0,1)
PFC = c(1,0,0, 1,0,0, 0,0,1, 0,0,0, 0,0,1)


contrast_forms_mod9 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC,
                          'Other Male Lecture'=OML, 'Other Male Collab'=OMC, 
                          'Other Female Lecture'=OFL,'Other Female Collab'=OFC,
                          'Island Male Lecture'=PML, 'Island Male Collab'=PMC, 
                          'Island Female Lecture'=PFL,'Island Female Collab'=PFC)

contrast_g9_est <- pool_and_cov_diffwm(gain9,contrast_forms_mod9)
contrast_g9_est$instruction <- factor(contrast_g9_est$instruction, levels = c("Lecture","Collab"))
ggplot(data=contrast_g9_est, aes(x=race_gender, y=Q, fill=instruction)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Lecture-based","Collaborative"),
                     values=plot_col) 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
#ggplot(data=contrast_g9_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+  facet_grid(.~instruction, scales = "free", space = "free")+  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +  ylab("Gain (Percentage Points)") +  scale_fill_manual(name="Gender",                     breaks= c("Female","Male"), values=cbbpalette) 
#ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/instruction.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g9_est[c(1,2,6,7)], digits = 2)
```

gain 10
```{r}
#     c(I,0,0, A,B,H, O,P,g, l,g*l)
WML = c(1,0,0, 0,0,0, 0,0,0, 1,0)
WMC = c(1,0,0, 0,0,0, 0,0,0, 0,0)
WFL = c(1,0,0, 0,0,0, 0,0,1, 1,1)
WFC = c(1,0,0, 0,0,0, 0,0,1, 0,0)

AML = c(1,0,0, 1,0,0, 0,0,0, 1,0)
AMC = c(1,0,0, 1,0,0, 0,0,0, 0,0)
AFL = c(1,0,0, 1,0,0, 0,0,1, 1,1)
AFC = c(1,0,0, 1,0,0, 0,0,1, 0,0)

BML = c(1,0,0, 0,1,0, 0,0,0, 1,0)
BMC = c(1,0,0, 0,1,0, 0,0,0, 0,0)
BFL = c(1,0,0, 0,1,0, 0,0,1, 1,1)
BFC = c(1,0,0, 0,1,0, 0,0,1, 0,0)

HML = c(1,0,0, 0,0,1, 0,0,0, 1,0)
HMC = c(1,0,0, 0,0,1, 0,0,0, 0,0)
HFL = c(1,0,0, 0,0,1, 0,0,1, 1,1)
HFC = c(1,0,0, 0,0,1, 0,0,1, 0,0)

OML = c(1,0,0, 0,0,0, 1,0,0, 1,0)
OMC = c(1,0,0, 0,0,0, 1,0,0, 0,0)
OFL = c(1,0,0, 0,0,0, 1,0,1, 1,1)
OFC = c(1,0,0, 0,0,0, 1,0,1, 0,0)

PML = c(1,0,0, 0,0,0, 0,1,0, 1,0)
PMC = c(1,0,0, 0,0,0, 0,1,0, 0,0)
PFL = c(1,0,0, 0,0,0, 0,1,1, 1,1)
PFC = c(1,0,0, 0,0,0, 0,1,1, 0,0)



contrast_forms_mod10 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC,
                          'Other Male Lecture'=OML, 'Other Male Collab'=OMC, 
                          'Other Female Lecture'=OFL,'Other Female Collab'=OFC,
                          'Island Male Lecture'=PML, 'Island Male Collab'=PMC, 
                          'Island Female Lecture'=PFL,'Island Female Collab'=PFC)

contrast_g10_est <- pool_and_cov_diffwm(gain10,contrast_forms_mod10)
contrast_g10_est$instruction <- factor(contrast_g9_est$instruction, levels = c("Lecture","Collab"))
ggplot(data=contrast_g10_est, aes(x=race_gender, y=Q, fill=instruction)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Lecture-based","Collaborative"),
                     values=plot_col) 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
ggplot(data=contrast_g10_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  facet_grid(.~instruction, scales = "free", space = "free")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 
#ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/instruction.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g10_est[c(1,2,6,7)], digits = 2)
```



model 11

```{r} 
#                              [Lecture Lecture   ]race x gender| lec X gend X race
#     c(I,L,A, B,H,O, P,F,0, 0, a,b, h,o,p,      f, A,B, H,O,P,  a,b,h, o,p)
WML = c(1,1,0, 0,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
WMC = c(1,0,0, 0,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
WFL = c(1,1,0, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,0,0,  0,0,0, 0,0)
WFC = c(1,0,0, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)

AML = c(1,1,1, 0,0,0, 0,0,0, 0, 1,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
AMC = c(1,0,1, 0,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
AFL = c(1,1,1, 0,0,0, 0,1,0, 0, 1,0, 0,0,0,      1, 1,0, 0,0,0,  1,0,0, 0,0)
AFC = c(1,0,1, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      0, 1,0, 0,0,0,  0,0,0, 0,0)

BML = c(1,1,0, 1,0,0, 0,0,0, 0, 0,1, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
BMC = c(1,0,0, 1,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
BFL = c(1,1,0, 1,0,0, 0,1,0, 0, 0,1, 0,0,0,      1, 0,1, 0,0,0,  0,1,0, 0,0)
BFC = c(1,0,0, 1,0,0, 0,1,0, 0, 0,0, 0,0,0,      0, 0,1, 0,0,0,  0,0,0, 0,0)

HML = c(1,1,0, 0,1,0, 0,0,0, 0, 0,0, 1,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
HMC = c(1,0,0, 0,1,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
HFL = c(1,1,0, 0,1,0, 0,1,0, 0, 0,0, 1,0,0,      1, 0,0, 1,0,0,  0,0,1, 0,0)
HFC = c(1,0,0, 0,1,0, 0,1,0, 0, 0,0, 0,0,0,      0, 0,0, 1,0,0,  0,0,0, 0,0)

OML = c(1,1,0, 0,0,1, 0,0,0, 0, 0,0, 0,1,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
OMC = c(1,0,0, 0,0,1, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
OFL = c(1,1,0, 0,0,1, 0,1,0, 0, 0,0, 0,1,0,      1, 0,0, 0,1,0,  0,0,0, 1,0)
OFC = c(1,0,0, 0,0,1, 0,1,0, 0, 0,0, 0,0,0,      0, 0,0, 0,1,0,  0,0,0, 0,0)

PML = c(1,1,0, 0,0,0, 1,0,0, 0, 0,0, 0,0,1,      0, 0,0, 0,0,0,  0,0,0, 0,0)
PMC = c(1,0,0, 0,0,0, 1,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
PFL = c(1,1,0, 0,0,0, 1,1,0, 0, 0,0, 0,0,1,      1, 0,0, 0,0,1,  0,0,0, 0,1)
PFC = c(1,0,0, 0,0,0, 1,1,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,1,  0,0,0, 0,0)

contrast_forms_mod11 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC,
                          'Other Male Lecture'=OML, 'Other Male Collab'=OMC, 
                          'Other Female Lecture'=OFL,'Other Female Collab'=OFC,
                          'Island Male Lecture'=PML, 'Island Male Collab'=PMC, 
                          'Island Female Lecture'=PFL,'Island Female Collab'=PFC)

contrast_g11_est <- pool_and_cov_diffwm(gain11,contrast_forms_mod11)
contrast_g11_est$instruction <- factor(contrast_g11_est$instruction, levels = c("Lecture","Collab"))

ggplot(data=contrast_g11_est, aes(x=race_gender, y=Q, fill=instruction)) +geom_bar(stat = "identity", position= "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_text(angle=90), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Lecture-based","Collaborative"),
                     values=plot_col) 
#facet_grid(.~race_gender, scales = "free", space = "free")+
#collab_plot <-  
#levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
ggplot(data=contrast_g11_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  facet_grid(.~instruction, scales = "free", space = "free")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 
#ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/instruction.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")
kable(contrast_g9_est[c(1,2,6,7)], digits = 2)
#model11
```




This produces the estimates for gain8


This function pools the results across the MI for each of the groups and calculates their covariance with white males
x=model, y= formula matrix
```{r}
pool_and_cov_1 <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T),
                            cvwm = mean(cov.White.Male.Lecture)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```




```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")

return <- p3est}
```

These are the differences with white males in that learning environment for Mod 8 where lecture isn't included
```{r}
#     c(I,0,0, F,A,B, H,O,P, ,a,b, h,o,p)
WFL = c(0,0,0, 1,0,0, 0,0,0, 0,0, 0,0,0)

AML = c(0,0,0, 0,1,0, 0,0,0, 0,0, 0,0,0)
AFL = c(0,0,0, 1,1,0, 0,0,0, 1,0, 0,0,0)

BML = c(0,0,0, 0,0,1, 0,0,0, 0,0, 0,0,0)
BFL = c(0,0,0, 1,0,1, 0,0,0, 0,1, 0,0,0)

HML = c(0,0,0, 0,0,0, 1,0,0, 0,0, 0,0,0)
HFL = c(0,0,0, 1,0,0, 1,0,0, 0,0, 1,0,0)

OML = c(0,0,0, 0,0,0, 0,1,0, 0,0, 0,0,0)
OFL = c(0,0,0, 1,0,0, 0,1,0, 0,0, 0,1,0)

PML = c(0,0,0, 0,0,0, 0,0,1, 0,0, 0,0,0)
PFL = c(0,0,0, 1,0,0, 0,0,1, 0,0, 0,0,1)


difference_forms_mod8 <- rbind('White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

```

```{r}
contrast_g8_est <- pool_and_cov_diffwm(gain8,difference_forms_mod8)

contrast_g8_est$instruction <- factor(contrast_g8_est$instruction, levels = c("Lecture","Collab"))

unique(contrast_g8_est$race_gender)

contrast_g8_est$group <- factor(contrast_g8_est$group, levels = c("White Female", "Asian Male", "Asian Female", "Hispanic Male", "Other Male", "Other Female", "Island Female", "Island Male",     "Black Female", "Hispanic Female", "Black Male"))

ggplot(data=contrast_g8_est, aes(x=group, y=Q, fill=gender)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  scale_fill_manual(name="Gender",
                     values=cbbpalette) +
  theme(legend.position = "bottom", axis.title.y=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_y_continuous(limits = c(-11,2), breaks = c(2,0,-2,-4,-6,-8,-10)) +
  coord_flip() 
  
ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/compare to WM.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")

  
 

kable(contrast_g8_est[c(1,2,6,7)], digits = 2)
```

```{r}

#     c(I,0,0, F,A,B, H,O,P, L,a,b, h,o,p)
WFL = c(0,0,0, 1,0,0, 0,0,0, 0,0,0, 0,0,0)
AML = c(0,0,0, 0,1,0, 0,0,0, 0,0,0, 0,0,0)
AFL = c(0,0,0, 1,1,0, 0,0,0, 0,1,0, 0,0,0)

BML = c(0,0,0, 0,0,1, 0,0,0, 0,0,0, 0,0,0)
BFL = c(0,0,0, 1,0,1, 0,0,0, 0,0,1, 0,0,0)

HML = c(0,0,0, 0,0,0, 1,0,0, 0,0,0, 0,0,0)
HFL = c(0,0,0, 1,0,0, 1,0,0, 0,0,0, 1,0,0)

OML = c(0,0,0, 0,0,0, 0,1,0, 0,0,0, 0,0,0)
OFL = c(0,0,0, 1,0,0, 0,1,0, 0,0,0, 0,1,0)

PML = c(0,0,0, 0,0,0, 0,0,1, 0,0,0, 0,0,0)
PFL = c(0,0,0, 1,0,0, 0,0,1, 0,0,0, 0,0,1)



difference_forms_mod9 <- rbind('White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_g9_est <- pool_and_cov_diffwm(gain9,difference_forms_mod9)

contrast_g9_est$instruction <- factor(contrast_g9_est$instruction, levels = c("Lecture","Collab"))


ggplot(data=contrast_g9_est, aes(x=group, y=Q)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  theme(legend.position = "bottom", axis.title.y=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain Relative to White Males (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col)+
  coord_flip()



  
  

kable(contrast_g8_est[c(1,2,6,7)], digits = 2)
```

```{r}

#                              [Lecture Lecture   ]race x gender| lec X gend X race
#     c(I,L,A, B,H,O, P,F,0, 0, a,b, h,o,p,      f, A,B, H,O,P,  a,b,h, o,p)
WFL = c(0,0,0, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,0,0,  0,0,0, 0,0)
AML = c(0,0,1, 0,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
AFL = c(0,0,1, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 1,0, 0,0,0,  0,0,0, 0,0)
BML = c(0,0,0, 1,0,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
BFL = c(0,0,0, 1,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,1, 0,0,0,  0,0,0, 0,0)
HML = c(0,0,0, 0,1,0, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
HFL = c(0,0,0, 0,1,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 1,0,0,  0,0,0, 0,0)
OML = c(0,0,0, 0,0,1, 0,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
OFL = c(0,0,0, 0,0,1, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,1,0,  0,0,0, 0,0)
PML = c(0,0,0, 0,0,0, 1,0,0, 0, 0,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
PFL = c(0,0,0, 0,0,0, 1,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,0,1,  0,0,0, 0,0)


difference_forms_mod11.1 <- rbind('White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_g11.1_est <- pool_and_cov_diffwm(gain11,difference_forms_mod11.1)

contrast_g11.1_est$instruction <- factor(contrast_g11.1_est$instruction, levels = c("Lecture","Collab"))


ggplot(data=contrast_g11.1_est, aes(x=group, y=Q)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  theme(legend.position = "bottom", axis.title.y=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col) +
  coord_flip()



  
  

kable(contrast_g11.1_est[c(1,2,6,7)], digits = 2)
```

```{r}

#                              [Lecture Lecture   ]race x gender| lec X gend X race
#     c(I,L,A, B,H,O, P,F,0, 0, a,b, h,o,p,      f, A,B, H,O,P,  a,b,h, o,p)
WFL = c(0,0,0, 0,0,0, 0,1,0, 0, 0,0, 0,0,0,      1, 0,0, 0,0,0,  0,0,0, 0,0)
AML = c(0,0,1, 0,0,0, 0,0,0, 0, 1,0, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
AFL = c(0,0,1, 0,0,0, 0,1,0, 0, 1,0, 0,0,0,      1, 1,0, 0,0,0,  1,0,0, 0,0)
BML = c(0,0,0, 1,0,0, 0,0,0, 0, 0,1, 0,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
BFL = c(0,0,0, 1,0,0, 0,1,0, 0, 0,1, 0,0,0,      1, 0,1, 0,0,0,  0,1,0, 0,0)
HML = c(0,0,0, 0,1,0, 0,0,0, 0, 0,0, 1,0,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
HFL = c(0,0,0, 0,1,0, 0,1,0, 0, 0,0, 1,0,0,      1, 0,0, 1,0,0,  0,0,1, 0,0)
OML = c(0,0,0, 0,0,1, 0,0,0, 0, 0,0, 0,1,0,      0, 0,0, 0,0,0,  0,0,0, 0,0)
OFL = c(0,0,0, 0,0,1, 0,1,0, 0, 0,0, 0,1,0,      1, 0,0, 0,1,0,  0,0,0, 1,0)
PML = c(0,0,0, 0,0,0, 1,0,0, 0, 0,0, 0,0,1,      0, 0,0, 0,0,0,  0,0,0, 0,0)
PFL = c(0,0,0, 0,0,0, 1,1,0, 0, 0,0, 0,0,1,      1, 0,0, 0,0,1,  0,0,0, 0,1)


difference_forms_mod11.2 <- rbind('White Female'=WFL,
                          'Black Male'=BML,  
                          'Black Female'=BFL,
                          'Asian Male'=AML, 
                          'Asian Female'=AFL,
                          'Hispanic Male'=HML, 
                          'Hispanic Female'=HFL,
                          'Other Male'=OML,  
                          'Other Female'=OFL,
                          'Island Male'=PML, 
                          'Island Female'=PFL)

contrast_g11.2_est <- pool_and_cov_diffwm(gain11,difference_forms_mod11.2)

contrast_g11.2_est$instruction <- factor(contrast_g11.2_est$instruction, levels = c("Lecture","Collab"))


ggplot(data=contrast_g11.2_est, aes(x=group, y=Q)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  theme(legend.position = "bottom", axis.title.y=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col) +
  coord_flip()



  
  

kable(contrast_g11.1_est[c(1,2,6,7)], digits = 2)
```




#OLD
This is the ratio stuff. It hasn't been worked through yet for our final model.
These are the differences with same group in lecture
These are really pointless and boring so I don't know why we would run them. I didn't finish updating this.
```{r}
WML = c(1,0,0,0,0,0,0,0,1)
WMC = c(1,0,0,0,0,0,0,0,0)
WFL = c(1,0,0,1,0,0,0,0,1)
WFC = c(1,0,0,1,0,0,0,0,0)
BML = c(1,0,0,0,0,1,0,0,1)
BMC = c(1,0,0,0,0,1,0,0,0)
BFL = c(1,0,0,1,0,1,0,0,1)
BFC = c(1,0,0,1,0,1,0,0,0)
AML = c(1,0,0,0,1,0,0,0,1)
AMC = c(1,0,0,0,1,0,0,0,0)
AFL = c(1,0,0,1,1,0,0,0,1)
AFC = c(1,0,0,1,1,0,0,0,0)
HML = c(1,0,0,0,0,0,1,0,1)
HMC = c(1,0,0,0,0,0,1,0,0)
HFL = c(1,0,0,1,0,0,1,0,1)
HFC = c(1,0,0,1,0,0,1,0,0)
OML = c(1,0,0,0,0,0,0,1,1)
OMC = c(1,0,0,0,0,0,0,1,0)
OFL = c(1,0,0,1,0,0,0,1,1)
OFC = c(1,0,0,1,0,0,0,1,0)
contrast_forms_mod8 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC,
                          'Other Male Lecture'=OML, 'Other Male Collab'=OMC, 
                          'Other Female Lecture'=OFL,'Other Female Collab'=OFC)
typeof(contrast_forms_mod8)
```

This function pools the results across the MI for each of the groups and calculates their covariance with themselves in lecture
x=model, y= formula matrix
```{r message=FALSE, warning=FALSE}
#pool_and_cov <- function(x,y){ #I'm just not going ot make this as a function for now since I am only going to run it once and it might be really tricky with differing sizes and positions for the variables
#This pulls out all of the relevant data from the anaylysis of the MId data.
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(gain9[[i]], linfct=contrast_forms_mod9)) #specifically for post3
  covp3 <- vcov(glht(gain9[[i]], linfct=contrast_forms_mod9))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}
# this pools the above data
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T))
#these add variable names useful for making figures
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
#return <- p3est
#return <- get.est}
#colnames(get.est)
#This needs to be organized alphabetically for the ratio code to work. Otherwise it will index with the wrong covariances.
cov_pooled <- get.est %>% group_by(group) %>% summarise(cov.Asian.Female.Collab = mean(cov.Asian.Female.Collab),
                                                   cov.Asian.Female.Lecture = mean(cov.Asian.Female.Lecture),
                                                   cov.Asian.Male.Collab = mean(cov.Asian.Male.Collab),
                                                   cov.Asian.Male.Lecture = mean(cov.Asian.Male.Lecture),
                                                   cov.Black.Female.Collab = mean(cov.Black.Female.Collab),
                                                   cov.Black.Female.Lecture = mean(cov.Black.Female.Lecture),
                                                   cov.Black.Male.Collab = mean(cov.Black.Male.Collab),
                                                   cov.Black.Male.Lecture = mean(cov.Black.Male.Lecture),
                                                   cov.Hispanic.Female.Collab = mean(cov.Hispanic.Female.Collab),
                                                   cov.Hispanic.Female.Lecture = mean(cov.Hispanic.Female.Lecture),
                                                   cov.Hispanic.Male.Collab = mean(cov.Hispanic.Male.Collab),
                                                   cov.Hispanic.Male.Lecture = mean(cov.Hispanic.Male.Lecture),
                                                   cov.Other.Female.Collab = mean(cov.Other.Female.Collab),
                                                   cov.Other.Female.Lecture = mean(cov.Other.Female.Lecture),
                                                   cov.Other.Male.Collab = mean(cov.Other.Male.Collab),
                                                   cov.Other.Male.Lecture = mean(cov.Other.Male.Lecture),
                                                   cov.White.Female.Collab = mean(cov.White.Female.Collab),
                                                   cov.White.Female.Lecture = mean(cov.White.Female.Lecture),
                                                   cov.White.Male.Collab = mean(cov.White.Male.Collab),
                                                   cov.White.Male.Lecture = mean(cov.White.Male.Lecture))
p3est <- left_join(p3est, cov_pooled, by = "group")
rats <- foreach(i=1:12, .combine=rbind) %do% {
  names <- p3est$race_gender[2*i]
  ratio <- p3est$Q[2*i-1]/p3est$Q[2*i]
  #se <-   sqrt( (p3est$Q[2*i-1]/p3est$Q[2*i])^2 *  ((p3est$T[2*i])/(p3est$Q[2*i]^2)  +  (p3est$T[2*i-1])/(p3est$Q[2*i-1]^2)  -2*(p3est[2*i,(11+2*i)]/((p3est$Q[2*i-1])*(p3est$Q[2*i])) )))
  data.frame(group=names,
             ratio = ratio,
             se=se[[1]])
}

t1 <- p3est[p3est$instruction == "Collab",]
t2 <- p3est[p3est$instruction == "Lecture",]
t3 <- left_join(t1[c(2,12)],t2[c(2,12)], by="race_gender" )
t3$rats <- t3$Q.x/t3$Q.y -1

#the se[[1]] is necessary due to a name problem. for whatever reasion the se function returns an object with a name.
```

```{r}
ggplot(t3, aes(y=rats, x=race_gender)) +geom_bar(stat="identity", fill='#fc8d62') +
  theme(legend.position = "bottom", axis.title.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black"),axis.text.x = element_text(angle = 90)) +
  ylab("Ratio with Self in Lecture") 
  ylim(c(0.8,2.4))



ggplot(rats, aes(y=ratio, x=group)) +geom_bar(stat="identity", fill='#fc8d62') +
  geom_errorbar(aes( ymax= ratio+1.96*se, ymin=ratio-1.96*se, width=0.5)) +
  theme(legend.position = "bottom", axis.title.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black"),axis.text.x = element_text(angle = 90)) +
  ylab("Ratio with Self in Lecture") 
  ylim(c(0.8,2.4))

  
  
  
  ggplot(data=contrast_g6_est, aes(x=instruction, y=Q, fill=instruction)) +geom_bar(stat = "identity", fill='#fc8d62') + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  facet_grid(.~race_gender, scales = "free", space = "free")+
   +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col) 
```





This function pools the results across the MI for each of the groups and calculates their covariance with white males
x=model, y= formula matrix
```{r}
pool_and_cov_1 <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T),
                            cvwm = mean(cov.White.Male.Lecture)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```



#Assumption checking

```{r}
	for (i in 1:10) {
  D1 <- lmer(mod9,data=MIdata[[i]])
  print(plot(D1, xlab="Fitted Value", ylab="Residual Variance"))
}
 
for (i in 1:10) {
  D1 <- lmer(mod9,data=MIdata[[i]])
#visual homogeneity of variance
MIdata[[i]]$Model.F.Res <- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[i]]$Abs.Model.F.Res <-abs(MIdata[[1]]$Model.F.Res) #creates a new column with the absolute value of the residuals
print(boxplot(MIdata[[i]]$Model.F.Res ~ MIdata[[i]]$course_id, xlab = "Course", ylab = "Residuals" ))
}
for (i in 1:10) {
  D1 <- lmer(mod9,data=MIdata[[i]])
#Assumption of Normality or residuals: want points to be near the line
print(qqmath(D1))
}
```
 # This produces a table of the pvalues for the correlations between the student level variables for pretest and the residuals. These p values should be large to indicate that there isn't a correlation
```{r}
res_corr <- data_frame(it =NA,
                       with_pre_score = NA,
                       with_cent_pre = NA)
 for (i in 1:10) {
res_corr[i,1] <- i
D1 <- lmer(mod9,data=MIdata[[i]])
temp <- cor.test(resid(D1), MIdata[[i]]$pre_score)
res_corr[i,2] <-  temp$p.value 
temp <-  cor.test(resid(D1), MIdata[[i]]$stud_pre_cent)
res_corr[i,3] <- temp$p.value
}
```	

```{r}
lev_p <- data_frame(it =NA,
                       p_values = NA)
 for (i in 1:10) {
lev_p[i,1] <-i
D1 <- lmer(mod9,data=MIdata[[i]])
MIdata[[i]]$Model.F.Res<- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[i]]$Abs.Model.F.Res <-abs(MIdata[[i]]$Model.F.Res) #creates a new column with the absolute value of the residuals
Levene.Model.F <- lm(Model.F.Res ~ course_id, data=MIdata[[i]]) #ANOVA of the residuals
temp <-anova(Levene.Model.F) #displays the results: want a p>0.05
lev_p[i,2] <- temp$`Pr(>F)`[[1]]
}
```

#Old assumption checking for just one MI dataset
Run 10 HLM 3 models
```{r}
D1 <- lmer(gain~1 + race_URM + gend_URM + stud_pre_cent + coll + (1|course_id),data=MIdata[[1]])
```

Assumption checking code to be done for all 10 datasets
```{r}
#linearity: Shouldn't see a pattern
plot(D1)
#variables are not correlated to the residuals: want a p-value>0.05
cor.test(resid(D1), MIdata[[1]]$pre_scor) 
cor.test(resid(D1), MIdata[[1]]$stud_pre_cent)
#quantitative homogeneity of variance
MIdata[[1]]$Model.F.Res<- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[1]]$Abs.Model.F.Res <-abs(MIdata[[1]]$Model.F.Res) #creates a new column with the absolute value of the residuals
#MIdata[[1]]$Model.F.Res2 <- MIdata[[1]]$Abs.Model.F.Res^2 #squares the absolute values of the residuals to provide the more robust estimate
Levene.Model.F <- lm(Model.F.Res ~ course_id, data=MIdata[[1]]) #ANOVA of the residuals
anova(Levene.Model.F) #displays the results: want a p>0.05
#Levene.Model.F2 <- lm(Model.F.Res2 ~ crse_id, data=MIdata[[1]]) #ANOVA of the squared residuals
#anova(Levene.Model.F2) #displays the results
#visual homogeneity of variance
boxplot(MIdata[[1]]$Model.F.Res ~ MIdata[[1]]$course_id)
#boxplot(MIdata[[1]]$Model.F.Res2 ~ MIdata[[1]]$crse_id)
#Assumption of Normality or residuals: want points to be near the line
qqmath(D1)
```


---
title: "Equity analysis"
output: html_document
---
I made a change
Load stuff (There are some packages that we don't need here, but I didn't clean them up. Sorry.)
```{r message=FALSE, warning=FALSE}
load("~/hmi_1_23_19")
#load("~/Physics_Equity/hmifall2018_m10_better")
#load("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity_new/hmifall2018_m10_better")


library(tidyr)
library("ggplot2")
library(gvlma)
library("HLMdiag")
library("DHARMa")
library("car") #for the Levene test which we will not discuss here
library("Matrix")
library(mitools)
library(stargazer)
library(lme4)
library(nlme)
library(mice)
library(mitml)
library(multcomp)
library(foreach)
library(ggplot2)
library(stringr)
library(dplyr)  #I load dplyr last because some of its functions (select) will be masked by plyr and it is a PITA to debug
library(kableExtra)


plot_col <- c('#66c2a5', '#fc8d62', '#8da0cb')
#cbbpalette <- c('#000000','#E69F00','#56B4E9')
cbbpalette <- c( "#009E73", "#e79f00", "#9ad0f3", "#0072B2", "#D55E00", 
    "#CC79A7","#000000", "#F0E442") #colorblind and grayscale friendly.

```

Creating mitml and extra variables
```{r}
#df_full <- complete(hmi.fall.2018)
#str(df_full)
MIdata<-mids2mitml.list(hmi_1_19) #converts file type

thing <- list()
for (i in 1:10){
  temp <- MIdata[[i]]
  class_means <- temp %>% group_by(course_id) %>% summarise(pre_mean_class = mean(pre_score))
  class_means$class_pre_cent <- class_means$pre_mean_class - mean(class_means$pre_mean_class)
  temp <- left_join(temp,class_means, by="course_id")
  temp$stud_pre_cent <- temp$pre_score - temp$pre_mean_class
  temp$gain <- temp$post_score - temp$pre_score
  temp$colab_no_la <- as.numeric(temp$colab_no_la)
  temp$la_in_lab <- as.numeric(temp$la_in_lab)
  temp$la_in_lecture <- as.numeric(temp$la_in_lecture)
  temp$la_in_rec <- as.numeric(temp$la_in_rec)
  temp$first_time <- as.numeric(temp$first_time)
  temp$coll <- temp$colab_no_la + temp$la_in_lab + temp$la_in_lecture + temp$la_in_rec - 4
  temp$retake <- ifelse (temp$first_time==1,1,0)
  temp$lec <- ifelse (temp$coll==1,0,1)
  temp$race_URM <- as.numeric(temp$black_no_int) + as.numeric(temp$hispanic_no_int) +
    as.numeric(temp$race_other_no_int)
  #assign(df.names[i], temp)
  thing[[i]] <- temp
  }
MIdata <- as.mitml.list(thing)

```


```{r }
gain1 <- with(MIdata,{lmer(gain~1 + (1|course_id))})
gain2 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + (1|course_id))})
gain3 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + (1|course_id))})
gain4 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + pre_mean_class + (1|course_id))})
gain5 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + FMCE + (1|course_id))})
gain6 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + (1|course_id))})
gain6.1 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + race_URM + (1|course_id))})
gain7 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + (1|course_id))})
gain8 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1|course_id))})
#gain8.1 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + asian_no_int + gend_URM*black_no_int + hispanic_no_int + race_other_no_int + lec + (1|course_id))})
gain8.2 <- with(MIdata,{lm(gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec)})
#gain8.3 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1|course_id) + (1|inst_id))})
#gain8.5 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1|course_id))})
gain9 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int) + lec + (1|course_id))})
gain10 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + gend_URM*lec +  (1|course_id))})
gain11 <- with(MIdata,{lmer(gain~1 + lec*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int) + gend_URM + stud_pre_cent + retake + (1|course_id))})
#gain12 <- with(MIdata,{lmer(gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1 + stud_pre_cent + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int |course_id))})
```

```{r echo=FALSE}
testEstimates(gain1, var.comp=TRUE)
testEstimates(gain2, var.comp=TRUE)
testEstimates(gain3, var.comp=TRUE)
testEstimates(gain4, var.comp=TRUE)
testEstimates(gain5, var.comp=TRUE) 
testEstimates(gain6, var.comp=TRUE)
testEstimates(gain6.1, var.comp=TRUE)
testEstimates(gain7, var.comp=TRUE)
testEstimates(gain8, var.comp=TRUE) #best model
#testEstimates(gain8.1, var.comp=TRUE)
testEstimates(gain8.2, var.comp=TRUE)
#testEstimates(gain8.3, var.comp=TRUE) we need to add in inst. ID.
testEstimates(gain8.5, var.comp=TRUE) #retake could preferentially impact races differently. Nope, not better.
testEstimates(gain9, var.comp=TRUE)
testEstimates(gain10, var.comp=TRUE)
testEstimates(gain11, var.comp=TRUE)
testEstimates(gain12, var.comp=TRUE) # very similar coefficients to model 8
```

This makes a table for the model development. Two sections need to be modified. The models and the equation column.
```{r}
models <- c("gain1","gain2","gain3","gain4","gain5","gain6","gain7","gain8","gain9","gain10","gain11")

mod_var_tab <- data_frame(model = NA,
                          level2 = NA,
                          level1 = NA,
                          ICC = NA)

for(i in 1:11){
  temp <- testEstimates(get(models[i]), var.comp=TRUE)
  mod_var_tab[i,1] <- models[i]
  mod_var_tab[i,2] <- temp$var.comp[1]
  mod_var_tab[i,3] <- temp$var.comp[2]
  mod_var_tab[i,4] <- temp$var.comp[3]
  }

mod_var_tab$lvl1change <- (mod_var_tab$level1[1]- mod_var_tab$level1)/mod_var_tab$level1[1]
mod_var_tab$lvl2change <- (mod_var_tab$level2[1]- mod_var_tab$level2)/mod_var_tab$level2[1]

mod_var_tab$equation <- c("gain~1 + (1|course_id)","gain~1 + stud_pre_cent + (1|course_id))","gain~1 + stud_pre_cent + retake + (1|course_id)","gain~1 + stud_pre_cent + retake + FMCE + (1|course_id)","gain~1 + stud_pre_cent + retake + FMCE + (1|course_id)","gain~1 + stud_pre_cent + retake + gend_URM + (1|course_id)", "gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + (1|course_id)","gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1|course_id)","gain~1 + stud_pre_cent + retake + gend_URM*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int) + lec + (1|course_id)","gain~1 + stud_pre_cent + retake + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + gend_URM*lec +  (1|course_id)","gain~1 + lec*(asian_no_int + black_no_int + hispanic_no_int + race_other_no_int) + gend_URM + stud_pre_cent + retake + (1|course_id)")

#"gain~1 + stud_pre_cent + retake + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int + lec + (1 + stud_pre_cent + gend_URM + asian_no_int + black_no_int + hispanic_no_int + race_other_no_int |course_id)"

```

This produces the estimates for gain8
```{r}
WML = c(1,0,0,0,0,0,0,0,1)
WMC = c(1,0,0,0,0,0,0,0,0)
WFL = c(1,0,0,1,0,0,0,0,1)
WFC = c(1,0,0,1,0,0,0,0,0)
BML = c(1,0,0,0,0,1,0,0,1)
BMC = c(1,0,0,0,0,1,0,0,0)
BFL = c(1,0,0,1,0,1,0,0,1)
BFC = c(1,0,0,1,0,1,0,0,0)
AML = c(1,0,0,0,1,0,0,0,1)
AMC = c(1,0,0,0,1,0,0,0,0)
AFL = c(1,0,0,1,1,0,0,0,1)
AFC = c(1,0,0,1,1,0,0,0,0)
HML = c(1,0,0,0,0,0,1,0,1)
HMC = c(1,0,0,0,0,0,1,0,0)
HFL = c(1,0,0,1,0,0,1,0,1)
HFC = c(1,0,0,1,0,0,1,0,0)
OML = c(1,0,0,0,0,0,0,1,1)
OMC = c(1,0,0,0,0,0,0,1,0)
OFL = c(1,0,0,1,0,0,0,1,1)
OFC = c(1,0,0,1,0,0,0,1,0)


contrast_forms_mod8 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC, 
                          'White Female Lecture'=WFL,'White Female Collab'=WFC,
                          'Black Male Lecture'=BML, 'Black Male Collab'=BMC, 
                          'Black Female Lecture'=BFL,'Black Female Collab'=BFC,
                          'Asian Male Lecture'=AML, 'Asian Male Collab'=AMC, 
                          'Asian Female Lecture'=AFL,'Asian Female Collab'=AFC,
                          'Hispanic Male Lecture'=HML, 'Hispanic Male Collab'=HMC, 
                          'Hispanic Female Lecture'=HFL,'Hispanic Female Collab'=HFC,
                          'Other Male Lecture'=OML, 'Other Male Collab'=OMC, 
                          'Other Female Lecture'=OFL,'Other Female Collab'=OFC)
```


These are the differences with white males in that learning environment
```{r}
WF = c(0,0,0,1,0,0,0,0,0)
BM = c(0,0,0,0,0,1,0,0,0)
BF = c(0,0,0,1,0,1,0,0,0)
AM = c(0,0,0,0,1,0,0,0,0)
AF = c(0,0,0,1,1,0,0,0,0)
HM = c(0,0,0,0,0,0,1,0,0)
HF = c(0,0,0,1,0,0,1,0,0)
OM = c(0,0,0,0,0,0,0,1,0)
OF = c(0,0,0,1,0,0,0,1,0)


difference_forms_wm_8 <- rbind( 
                          'White Female'=WF, 
                          'Black Male'=BM, 'Black Female'=BF,
                          'Asian Male'=AM, 'Asian Female'=AF,
                          'Hispanic Male'=HM, 'Hispanic Female'=HF,
                          'Other Male'=OM, 'Other Female'=OF)
```

These are the differences with same group in lecture
These are really pointless and boring so I don't know why we would run them. I didn't finish updating this.
```{r include=FALSE}
difference_forms_self_6 <- data.frame(
"White Male" = c(0,0,0,0,0,0,0,0,1),
WFL = c(0,0,0,0,0,0,0,0,1),
WFC = c(0,0,0,0,0,0,0,0,1),
BML = c(0,0,0,0,0,0,0,0,1),
BMC = c(0,0,0,0,0,0,0,0,1),
BFL = c(0,0,0,0,0,0,0,0,1),
BFC = c(0,0,0,0,0,0,0,0,1),
AML = c(0,0,0,0,0,0,0,0,1),
AMC = c(0,0,0,0,0,0,0,0,1),
AFL = c(0,0,0,0,0,0,0,0,1),
AFC = c(0,0,0,0,0,0,0,0,1),
HML = c(0,0,0,0,0,0,0,0,1),
HMC = c(1,0,0,0,0,0,1,0,0),
HFL = c(1,0,0,1,0,0,1,0,1),
HFC = c(1,0,0,1,0,0,1,0,0),
OML = c(1,0,0,0,0,0,0,1,1),
OMC = c(1,0,0,0,0,0,0,1,0),
OFL = c(1,0,0,1,0,0,0,1,1),
OFC = c(1,0,0,1,0,0,0,1,0))

WM = c(0,0,0,0, 1)
BM = c(0,0,0,0, 1)
WF = c(0,0,0,0, 1)
BF = c(0,0,0,0, 1)

difference_forms_self_6 <- rbind('White Male' = WM,
                          'Black Male'=BM, 
                          'White Female'=WF, 
                          'Black Female'=BF)
```

This is the difference with White Males in the same course.
This is above.
```{r eval=FALSE, include=FALSE}
BML = c(0,1,0,0, 0)
WFL = c(0,0,1,0, 0)
BFL = c(0,1,1,0, 0)
BMC = c(0,1,0,0, 0)
WFC = c(0,0,1,0, 0)
BFC = c(0,1,1,0, 0)

difference_forms_wm_6 <- rbind( 
                          'URM Male Lecture'=BML, 'URM Male Collab'=BMC, 
                          'Majority Female Lecture'=WFL,'Majority Female Collab'=WFC, 
                          'URM Female Lecture'=BFL,'URM Female Collab'=BFC)

contrast_g6_est <- pool_and_cov_diffwm(gain6,contrast_forms_mod6)
```


This function pools the results across the MI for each of the groups and calculates their covariance with themselves in lecture
x=model, y= formula matrix
```{r message=FALSE, warning=FALSE}
#pool_and_cov <- function(x,y){ #I'm just not going ot make this as a function for now since I am only going to run it once and it might be really tricky with differing sizes and positions for the variables
#This pulls out all of the relevant data from the anaylysis of the MId data.
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(gain8[[i]], linfct=contrast_forms_mod8)) #specifically for post3
  covp3 <- vcov(glht(gain8[[i]], linfct=contrast_forms_mod8))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}

# this pools the above data
p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T))

#these add variable names useful for making figures
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
#return <- p3est
#return <- get.est}

#colnames(get.est)
#This needs to be organized alphabetically for the ratio code to work. Otherwise it will index with the wrong covariances.
cov_pooled <- get.est %>% group_by(group) %>% summarise(cov.Asian.Female.Collab = mean(cov.Asian.Female.Collab),
                                                   cov.Asian.Female.Lecture = mean(cov.Asian.Female.Lecture),
                                                   cov.Asian.Male.Collab = mean(cov.Asian.Male.Collab),
                                                   cov.Asian.Male.Lecture = mean(cov.Asian.Male.Lecture),
                                                   cov.Black.Female.Collab = mean(cov.Black.Female.Collab),
                                                   cov.Black.Female.Lecture = mean(cov.Black.Female.Lecture),
                                                   cov.Black.Male.Collab = mean(cov.Black.Male.Collab),
                                                   cov.Black.Male.Lecture = mean(cov.Black.Male.Lecture),
                                                   cov.Hispanic.Female.Collab = mean(cov.Hispanic.Female.Collab),
                                                   cov.Hispanic.Female.Lecture = mean(cov.Hispanic.Female.Lecture),
                                                   cov.Hispanic.Male.Collab = mean(cov.Hispanic.Male.Collab),
                                                   cov.Hispanic.Male.Lecture = mean(cov.Hispanic.Male.Lecture),
                                                   cov.Other.Female.Collab = mean(cov.Other.Female.Collab),
                                                   cov.Other.Female.Lecture = mean(cov.Other.Female.Lecture),
                                                   cov.Other.Male.Collab = mean(cov.Other.Male.Collab),
                                                   cov.Other.Male.Lecture = mean(cov.Other.Male.Lecture),
                                                   cov.White.Female.Collab = mean(cov.White.Female.Collab),
                                                   cov.White.Female.Lecture = mean(cov.White.Female.Lecture),
                                                   cov.White.Male.Collab = mean(cov.White.Male.Collab),
                                                   cov.White.Male.Lecture = mean(cov.White.Male.Lecture))

p3est <- left_join(p3est, cov_pooled, by = "group")

rats <- foreach(i=1:10, .combine=rbind) %do% {
  names <- p3est$race_gender[2*i]
  ratio <- p3est$Q[2*i-1]/p3est$Q[2*i]
  se <-   sqrt( (p3est$Q[2*i-1]/p3est$Q[2*i])^2 *  ((p3est$T[2*i])/(p3est$Q[2*i]^2)  +  (p3est$T[2*i-1])/(p3est$Q[2*i-1]^2)  -2*(p3est[2*i,(11+2*i)]/((p3est$Q[2*i-1])*(p3est$Q[2*i])) )))
  data.frame(group=names,
             ratio = ratio,
             se=se[[1]])
}
#the se[[1]] is necessary due to a name problem. for whatever reasion the se function returns an object with a name.
```

```{r}
ggplot(rats, aes(y=ratio, x=group)) +geom_bar(stat="identity", fill='#fc8d62') +
  geom_errorbar(aes( ymax= ratio+1.96*se, ymin=ratio-1.96*se, width=0.5)) +
  theme(legend.position = "bottom", axis.title.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black"),axis.text.x = element_text(angle = 90)) +
  ylab("Ratio with Self in Lecture") 
  ylim(c(0.8,2.4))

ggplot(data=contrast_g6_est, aes(x=instruction, y=Q, fill=instruction)) +geom_bar(stat = "identity", fill='#fc8d62') + geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE))+
  facet_grid(.~race_gender, scales = "free", space = "free")+
   +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col) 



```





This function pools the results across the MI for each of the groups and calculates their covariance with white males
x=model, y= formula matrix
```{r}
pool_and_cov <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T),
                            cvwm = mean(cov.White.Male.Lecture)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")
return <- p3est}
```


```{r}
pool_and_cov_diffwm <- function(x,y){
  get.est <- foreach(i=1:10, .combine=rbind) %do% {
  sxp3 <- summary(glht(x[[i]], linfct=y)) #specifically for post3
  covp3 <- vcov(glht(x[[i]], linfct=y))
  data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
}


p3est <- get.est %>% group_by(group) %>% 
                  summarise(Q = mean(d), 
                            U = mean(var.d), 
                            B = var(d), 
                            T = U + ((1+1/max(imp))*B), 
                            LCL = Q - 1.96*sqrt(T), 
                            UCL = Q + 1.96*sqrt(T),
                            SE = sqrt(T)) 
p3est$race <- word(p3est$group, 1)
p3est$gender <- word(p3est$group, 2)
p3est$instruction <- word(p3est$group, 3)
p3est$race_gender <- paste(p3est$race,p3est$gender, sep= " ")

return <- p3est}
```

```{r}
contrast_g6_est <- pool_and_cov_diffwm(gain8,contrast_forms_mod8)

contrast_g6_est$instruction <- factor(contrast_g6_est$instruction, levels = c("Lecture","Collab"))


ggplot(data=contrast_g6_est, aes(x=instruction, y=Q, fill=instruction)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE))+
  facet_grid(.~race_gender, scales = "free", space = "free")+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Instruction",
                     breaks= c("Lecture","Collab"),
                     labels=c("Lecture-based","Collaborative"),
                     values=plot_col) 

#collab_plot <-  
levels(contrast_g6_est$instruction) <- c("Lecture", "Collaborative")
ggplot(data=contrast_g6_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  facet_grid(.~instruction, scales = "free", space = "free")+
  theme(legend.position = "right",  axis.text.x=element_text(angle=90) , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 

ggsave("~/Documents/LA Postdoc stuff copy/RData/LASSO/Denver-Chico_collaboration/Physics_Equity/instruction.png", plot= last_plot(), dpi=300, width = 7.3, height = 3.25, units = "in", device = "png")


library(cowplot)
plot_grid(collab_plot, lecture_plot, ncol=2, labels = c("Collaborative", "Lecture"), align="hv")

kable(contrast_g6_est[c(1,2,6,7)], digits = 2)
```

Combining some figures to help see how the two models compare
```{r}

AAA <-   ggplot(data=contrast_g6_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  facet_grid(.~instruction, scales = "free", space = "free")+
  theme(legend.position = "right",  axis.text.x=element_blank() , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 

BBB <- ggplot(data=contrast_g9_est, aes(x=race, y=Q, fill=gender)) +geom_bar(stat = "identity", position = "dodge") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE), position="dodge")+
  facet_grid(.~instruction, scales = "free", space = "free")+
  theme(legend.position = "right",  axis.text.x=element_blank() , axis.title.x = element_blank(), axis.ticks.x=element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  ylab("Gain (Percentage Points)") +
  scale_fill_manual(name="Gender",
                     breaks= c("Female","Male"),
                     values=cbbpalette) 
library(cowplot)
plot_grid(AAA, BBB, nrow = 2)

```






This figure isn't very interesting. It shows a difference of 6 with a 95% CI from ~2.4 to 10 
```{r}
diff_self_g6_est <- pool_and_cov_diffwm(gain6,difference_forms_self_6)
ggplot(data=diff_self_g6_est, aes(x=group, y=Q)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+2*SE, ymin=Q-2*SE))
```



```{r}
diff_wm_g6_est <- pool_and_cov_diffwm(gain6,difference_forms_wm_6)

diff_wm_g6_est$instruction <- factor(diff_wm_g6_est$instruction, levels = c("Lecture","Collab"))

ggplot(data=diff_wm_g6_est[diff_wm_g6_est$instruction=="Lecture",], aes(x=race_gender, y=Q, fill=instruction)) +geom_bar(stat = "identity") + coord_flip() + 
  geom_errorbar(aes( ymax= Q+1.96*SE, ymin=Q-1.96*SE, width=0.5))+
  theme(legend.position = "none",strip.background = element_blank(),
  strip.text.y = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"),text = element_text(size=16, color = "black")) +
  xlab("")+ ylab("Gain Relative to Majority Males") +
  scale_fill_manual(name="Instruction",
                       breaks= c("Lecture","Collab"),
                     labels=c("Traditional","Collaborative"),
                     values=plot_col) +
  scale_y_continuous(limits = c(-9,9),breaks = seq(-8, 8, by = 2))
```


```{r}
contrast_g5_est <- pool_and_cov_diffwm(gain5,contrast_forms_mod5)
ggplot(data=contrast_g5_est, aes(x=group, y=Q, fill=instruction)) +geom_bar(stat = "identity") + geom_errorbar(aes( ymax= Q+SE, ymin=Q-SE))+
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```

```{r}
temp <- contrast_g5_est[c(2,11,12)]
temp2 <- temp[temp$instruction=="Collab",]
temp3 <- temp[temp$instruction=="Lecture",]
temp4 <- left_join(temp2,temp3, by="race_gender")

temp4$ratio_self <- temp4$Q.x/temp4$Q.y

ggplot(data=temp4, aes(x=race_gender, y=ratio_self)) +geom_bar(stat = "identity")  

```

```{r}
temp <- contrast_g5_est[c(1,2,11,12)] 
temp$ratio_wml <- temp$Q/15.32
ggplot(data=temp, aes(x=group, y=ratio_wml, fill=instruction)) +geom_bar(stat = "identity") + 
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```


```{r}
temp <- contrast_g5_est[c(1,2,11,12)]
temp2 <- temp[temp$instruction=="Collab",]
temp2$ratio_wm_same <- temp2$Q/21.993
temp3 <- temp[temp$instruction=="Lecture",]
temp3$ratio_wm_same <- temp3$Q/15.931
temp4 <- bind_rows(temp2,temp3)

ggplot(data=temp4, aes(x=group, y=ratio_wm_same, fill=instruction)) +geom_bar(stat = "identity") + 
  facet_grid(.~race_gender)+
  theme(legend.position = "bottom", axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```


I want to run it to make the ratios with error bars against self in lecture
```{r}
WML = c(1,0,0,0, 0,0,0,0)
WMC = c(1,0,1,0, 0,0,0,0)

contrast_self_mod4 <- rbind('White Male Lecture'=WML, 'White Male Collab'=WMC)

diff_wm_g4_est <- pool_and_cov_diffwm(gain4,difference_forms_wm_4)


sxp3 <- summary(glht(gain4[[1]], linfct=contrast_self_mod4)) #specifically for post3
  covp3 <- vcov(glht(gain4[[1]], linfct=contrast_self_mod4))
thing <-data.frame(imp=i, 
             group=rownames(sxp3$linfct),
             d = sxp3$test$coefficients, 
             var.d = (sxp3$test$sigma)^2,
             cov = covp3)
```

#Assumption checking

```{r}
	for (i in 1:10) {
  D1 <- lmer(mod6,data=MIdata[[i]])
  print(plot(D1, xlab="Fitted Value", ylab="Residual Variance"))
}
 

for (i in 1:10) {
  D1 <- lmer(mod6,data=MIdata[[i]])
#visual homogeneity of variance
MIdata[[i]]$Model.F.Res <- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[i]]$Abs.Model.F.Res <-abs(MIdata[[1]]$Model.F.Res) #creates a new column with the absolute value of the residuals
print(boxplot(MIdata[[i]]$Model.F.Res ~ MIdata[[i]]$course_id, xlab = "Course", ylab = "Residuals" ))
}

for (i in 1:10) {
  D1 <- lmer(mod6,data=MIdata[[i]])
#Assumption of Normality or residuals: want points to be near the line
print(qqmath(D1))
}
```
 # This produces a table of the pvalues for the correlations between the student level variables for pretest and the residuals. These p values should be large to indicate that there isn't a correlation
```{r}
res_corr <- data_frame(it =NA,
                       with_pre_score = NA,
                       with_cent_pre = NA)
 for (i in 1:10) {
res_corr[i,1] <- i
D1 <- lmer(mod6,data=MIdata[[i]])
temp <- cor.test(resid(D1), MIdata[[i]]$pre_score)
res_corr[i,2] <-  temp$p.value 
temp <-  cor.test(resid(D1), MIdata[[i]]$stud_pre_cent)
res_corr[i,3] <- temp$p.value
}
```	

```{r}
lev_p <- data_frame(it =NA,
                       p_values = NA)
 for (i in 1:10) {
lev_p[i,1] <-i
D1 <- lmer(mod6,data=MIdata[[i]])
MIdata[[i]]$Model.F.Res<- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[i]]$Abs.Model.F.Res <-abs(MIdata[[i]]$Model.F.Res) #creates a new column with the absolute value of the residuals
Levene.Model.F <- lm(Model.F.Res ~ course_id, data=MIdata[[i]]) #ANOVA of the residuals
temp <-anova(Levene.Model.F) #displays the results: want a p>0.05
lev_p[i,2] <- temp$`Pr(>F)`[[1]]
}
```

#Old assumption checking for just one MI dataset
Run 10 HLM 3 models
```{r}
D1 <- lmer(gain~1 + race_URM + gend_URM + stud_pre_cent + coll + (1|course_id),data=MIdata[[1]])
```

Assumption checking code to be done for all 10 datasets
```{r}
#linearity: Shouldn't see a pattern
plot(D1)

#variables are not correlated to the residuals: want a p-value>0.05
cor.test(resid(D1), MIdata[[1]]$pre_scor) 
cor.test(resid(D1), MIdata[[1]]$stud_pre_cent)

#quantitative homogeneity of variance
MIdata[[1]]$Model.F.Res<- residuals(D1) #extracts the residuals and places them in a new column in our original data table
MIdata[[1]]$Abs.Model.F.Res <-abs(MIdata[[1]]$Model.F.Res) #creates a new column with the absolute value of the residuals
#MIdata[[1]]$Model.F.Res2 <- MIdata[[1]]$Abs.Model.F.Res^2 #squares the absolute values of the residuals to provide the more robust estimate

Levene.Model.F <- lm(Model.F.Res ~ course_id, data=MIdata[[1]]) #ANOVA of the residuals
anova(Levene.Model.F) #displays the results: want a p>0.05

#Levene.Model.F2 <- lm(Model.F.Res2 ~ crse_id, data=MIdata[[1]]) #ANOVA of the squared residuals
#anova(Levene.Model.F2) #displays the results

#visual homogeneity of variance
boxplot(MIdata[[1]]$Model.F.Res ~ MIdata[[1]]$course_id)
#boxplot(MIdata[[1]]$Model.F.Res2 ~ MIdata[[1]]$crse_id)

#Assumption of Normality or residuals: want points to be near the line
qqmath(D1)
```


